{% extends "base.html" %}

{% block content %}
 <!--begin::App Content Header-->
        <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6"><h4 class="mb-0">全部监控频道</h4></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">

                     <li class="breadcrumb-item active" aria-current="page">
                        <a href="{{ url_for('discord.index') }}" >
                            <button type="button"  class="layui-btn layui-btn-touyan" ><b>Discord账号列表</b></button>
                        </a>
                    </li>

                  <li class="breadcrumb-item active" aria-current="page">
                      <a href="{{ url_for('discord.message') }}" >
                        <button type="button" class="layui-btn layui-btn-touyan"><b>查看全部监控信息</b></button>
                      </a>
                  </li>
                </ol>
              </div>
            </div>

            <div class="layui-btn-container" id="category_html">

            </div>

            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">
                 <!--begin::Row-->
                    <div  style="text-align:center;">

                    <div class="layui-form-item">
                    <div class="layui-inline">
                      <label class="layui-form-label">搜索：</label>
                      <div class="layui-input-inline layui-input-wrap" style="width:500px;">
                        <input type="input" name="keyword" id="search_keyword" lay-verify="required|phone" autocomplete="off" lay-reqtext="请填写手机号" lay-affix="clear" class="layui-input demo-phone">
                      </div>
                      <div class="layui-form-mid" style="padding: 0!important;">
                        <button type="button" class="layui-btn layui-btn-primary" id="search_keyword_button" lay-on="get-vercode">开始搜索</button>
                      </div>
                    </div>
                      </div>

                    </div>
                <!--end::Row-->
               <div class="card mb-4">
                  <div class="card-header">
                    <h3 class="card-title">Discord监控频道</h3>
                  </div>
                  <!-- /.card-header -->
                  <div class="card-body p-0">

                    <table class="table table-striped" style="text-align: center;">
                      <thead>
                        <tr >
                          <th style="width: 80px;">序号</th>
                          <th >服务器名</th>
                          <th >频道名称</th>
                          <th >所属账号</th>
                          <!--<th >服务器ID/频道ID</th>-->
                          <th >备注信息</th>
                          <th >操作</th>
                        </tr>
                      </thead>
                      <tbody id="data-table">

                      </tbody>
                    </table>

                    <div class="toolbar-checkbox-wrapper">
                      <div class="layui-form toolbar-checkbox-left" id="check_all_data">
                        <button type="button" class="layui-btn layui-btn-sm layui-btn-touyan" id="toggleSelectBtn" data-status="unselected">全选</button>
                        <button type="button" class="layui-btn layui-btn-sm layui-bg-red " id="batchDeleteBtn">批量删除</button>
                      </div>

                      <div id="demo-laypage-all" class="toolbar-checkbox-right"></div>
                    </div>

                  </div>
                  <!-- /.card-body -->
                </div>
                <!-- /.card -->


          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->

<script>

layui.use(['laypage', 'jquery'], function() {
  var laypage = layui.laypage;
  var $ = layui.jquery;
  const token = localStorage.getItem('token');
  let  did = 0;

  // 增加discord 委托给 body 或更合适的父容器
  $('body').on('click', '#show-channel-demo-base-text', function () {
        // 在此处输入 layer 的任意代码
        layer.open({
          type: 1, // page 层类型

          title: '怎么取Discord的频道链接的教程',
          shadeClose: true, // 点击遮罩区域，关闭弹层
          maxmin: true, // 允许全屏最小化
          anim: 0, // 0-6 的动画形式，-1 不开启
          content: '<div style="padding: 32px;"><img src="/static/dist/img/discord_channel.png?1331" style="width:1210px;height:760px;" alt="Logo" ></div>'
        });
  });

    // 批量删除按钮监听（动态项）
    $('body').on('click', '#batchDeleteBtn', function () {
      if (selectedIds.size === 0) {
        return layer.msg("请至少选择一项进行删除");
      }

      const ids = Array.from(selectedIds);
      console.log('checkbox ids:', ids);
      layer.confirm(`确认删除 ${ids.length} 项吗？`, function (index) {
        $.ajax({
          url: '{{ url_for('discord.delete_channel') }}',
          type: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
          },
          contentType: 'application/json',
          data: JSON.stringify({ ids }),  // ✅ 正确传 JSON
          success:function(result){
            if(result.status == 1){
              layer.msg("删除成功");

              // 删除成功后，清除已选中的 ID
              ids.forEach(id => selectedIds.delete(String(id)));

              // 重新拉取数据
              fetchData(1, 10,{{did}});  // 默认加载第1页，10条数据
            } else {
              layer.msg(result.message || "删除失败");
            }
          },
          error: function () {
            layer.msg("请求失败");
          }
        });

        layer.close(index);
      });
    });


  // 监听分类按钮点击
  $('#category_html').on('click', '.layui-btn', function() {
    did = $(this).data('id');

    // 样式切换：移除其他按钮的 cur，添加当前按钮的 cur
    $('#category_html .layui-btn').removeClass('layui-btn-touyan');
    $('#category_html .layui-btn').addClass('layui-btn-primary');
    $(this).addClass('layui-btn-touyan');

    fetchData(1, 10,did); // 点击分类时重置为第一页
  });

 // 增加discord 委托给 body 或更合适的父容器
  $('body').on('blur', '#add-token-input', function () {
    const discord_token = $(this).val().trim();
    if (discord_token) {
      $.ajax({
        url: '/api/auth/get_discord',  // 你需要创建这个后端路由
        type: 'GET',
        headers: {
        'Authorization': 'Bearer ' + token,
        },
        contentType: 'application/json',
        data: { token: discord_token },
        success: function (res) {
          if (res.status) {
            $("#add-username").val(res.data.username)
            $("#add-remark").val(res.data.global_name)
            $("#add-email").val(res.data.email)
          } else {
            layer.msg('获取失败：' + res.message);
          }
        },
        error: function () {
           layer.msg('服务器错误，请稍后重试');
        }
      });
    }
  });



  // 自动取discord的guild_id和channel_id
  $('body').on('blur', '#edit-discord-input', function () {
    const discord_url = $(this).val().trim();
    const discord_token = $("#my_discord_token").val();      // 获取 data-discord_token 的值

    // 校验格式 + 提取 ID
    const match = discord_url.match(/^https:\/\/discord\.com\/channels\/(\d+)\/(\d+)$/);

    if (match) {
      const guild_id = match[1];  // 第一个数字
      const channel_id = match[2];  // 第二个数字
      $("#edit-guild").val(guild_id)
      $("#edit-channel").val(channel_id)
              if (discord_token) {
          $.ajax({
            url: '/api/auth/get_channel',  // 你需要创建这个后端路由
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            contentType: 'application/json',
            data: { token: discord_token,channel_id: channel_id,guild_id: guild_id },
            success: function (res) {
              if (res.status) {
                $("#edit-username").val(res.data.name)
                $("#edit-remark").val('监控服务器：'+res.data.guild_name+' 的 '+res.data.name+' 频道')
                $("#guild_name").val(res.data.guild_name)
                $("#guild_icon").val(res.data.guild_icon)
                $("#guild_description").val(res.data.guild_description)

              } else {
                layer.msg('未加入此服务器或网络出错，失败原因：' + res.message);
              }
            },
            error: function () {
               layer.msg('未加入此服务器或网络错误，请稍后重试');
            }
          });
        }

      console.log("Guild ID:", guild_id);
      console.log("Channel ID:", channel_id);
    } else {

       layer.msg('Discord链接URL格式不正确,参考例子：<br/>https://discord.com/<span style="color:#ff5722;">channels</span>/<span style="color:#ffb800;">1141419161893998702</span>/<span style="color:#1e9fff;">1260130052956360724</span>', {
          time: 3000 // 3 秒后自动关闭
        });
       return
    }
  });
 // 修改discord
  $('body').on('blur', '#edit-token-input', function () {
    const discord_token = $(this).val().trim();
    if (discord_token) {
      $.ajax({
        url: '/api/auth/get_discord',  // 你需要创建这个后端路由
        type: 'GET',
        headers: {
        'Authorization': 'Bearer ' + token,
        },
        contentType: 'application/json',
        data: { token: discord_token },
        success: function (res) {
          if (res.status) {
            $("#edit-username").val(res.data.username)
            $("#edit-remark").val(res.data.global_name)
            $("#edit-email").val(res.data.email)
          } else {
            layer.msg('获取失败：' + res.message);
          }
        },
        error: function () {
           layer.msg('服务器错误，请稍后重试');
        }
      });
    }
  });

  // 增加搜索委托给 body 或更合适的父容器
  $('body').on('click keydown', '#search_keyword_button, #search_keyword', function (e) {
      if (e.type === 'click' || (e.type === 'keydown' && e.key === 'Enter')) {
        const keyword = $("#search_keyword").val().trim();

        fetchData(1, 10,0, keyword);  // 默认加载第1页，10条数据
      }
  });

  let currentKeyword = ''; // 全局变量，记住 keyword

  //将函数挂载到 window，变成全局函数
  window.fetchData = function (page, limit, did, keyword) {
    currentKeyword = keyword || '';  // 每次 fetch 更新当前 keyword
    $.ajax({
      url: '{{ url_for('discord.page_channel') }}',  // 替换为你的后端接口
      type: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      data: { page: page, limit: limit, did: did,keyword: currentKeyword },
      success: function(res) {
        // 假设 res 格式：{ code: 0, count: 100, data: [...] }
        if (res.code === 0) {
          renderTable(res.data);  // 渲染表格
          laypage.render({
            elem: 'demo-laypage-all',
            count: res.count,
            limit: limit,
            curr: page,
            layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'], // 功能布局
            jump: function(obj, first) {
              if (!first) {
                fetchData(obj.curr, obj.limit, did,currentKeyword);  // 重新获取数据
              }
            }
          });
        }
      }
    });
  }

  function renderTable(data) {
    var html = '';
    const colorClasses = [
      'layui-bg-orange',
      'layui-bg-green',
      'layui-bg-cyan',
      'layui-bg-blue',
      'layui-bg-black'
    ];


    data.forEach(function(item) {
      // 随机选择一个 class
      const randomClass = colorClasses[Math.floor(Math.random() * colorClasses.length)];
      const isYesChecked = selectedIds.has(String(item.id)) ? 'checked' : '';
      html += `<tr class="align-middle" id="del_discord_${item.id}">
                          <td  style="text-align:left;">
                              <div class="layui-form">
                                   <input type="checkbox" name="checkItem" value="${item.id}"  lay-filter="checkItem"   data-id="${item.id}" lay-skin="primary" ${isYesChecked}   > ${item.num}.
                              </div>
                          </td>
                          <td><a href="${item.url}" class="alert-link" target="_blank"><img src="https://cdn.discordapp.com/icons/${item.guild_id}/${item.guild_icon}.jpeg" class="user-image rounded-circle shadow"  style="width:30px; height:30px;" alt="User Image"><br/> ${item.guild_name}</a></td>
                          <td><a href="${item.url}" class="alert-link" target="_blank"><span class="layui-badge ${randomClass}">${item.username}</span></a></td>
                          <!--<td><a href="${item.url}" class="alert-link" target="_blank">${item.guild_id}</br>${item.channel_id}</a></td>-->
                          <td>${item.discord_name}</td>
                          <td>${item.remark}</td>
                          <td style="text-align:right;">
                           <span><a href="/discord/message/gid/${item.guild_id}" class="alert-link" ><button type="button" class="layui-btn  layui-btn-sm" style="background-color: #16b777;">消息列表</button></a></span>

                          <span   lay-on="add-channel-confirm"  data-id="${item.did}"  data-title="${item.discord_name}" data-discord-token="${item.token}"  ><button type="button" class="layui-btn  layui-btn-sm" style="background-color: #16b777;">增加监控</button></span>

                          <span   lay-on="edit-confirm"  data-id="${item.id}" data-did="${item.did}" data-discord-token="${item.token}"  data-username="${item.username}"
                          data-guild-id="${item.guild_id}" data-guild-name="${item.guild_name}"  data-guild-icon="${item.guild_icon}" data-guild-description="${item.guild_description}"
                            data-channel-id="${item.channel_id}"   data-remark="${item.remark}"   data-url="${item.url}"
                           >
                          <button type="button" class="layui-btn layui-bg-blue  layui-btn-sm">修改</button>
                          </span>
                           <span   lay-on="del-discord-confirm"  data-id="${item.id}" ><button type="button" class="layui-btn layui-bg-red  layui-btn-sm">删除</button></span>
                           </td>
                        </tr>`;
    });
    $('#data-table').html(html);
    // 先渲染 layui checkbox 外观
      layui.form.render('checkbox');

      // 再设置选中状态
      $('#data-table input[name="checkItem"]').each(function () {
        const id = String($(this).data('id'));
        if (selectedIds.has(id)) {
          $(this).prop('checked', true);
        } else {
          $(this).prop('checked', false);
        }
      });

      updateToggleSelectBtnStatus()
  }


  // ✅ 取到分类列表
  function getCategory(){
       const  did = {{did}};
       const token = localStorage.getItem('token');
       $.ajax({
        url:'{{ url_for('discord.list_data') }}',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        type: 'GET',
        data: { is_type: 2 },
        success: function(res) {
          if (res.status === 1 && Array.isArray(res.data)) {
            const select = $('#category_html');
            select.empty();  // 清空旧内容
            if (did>0) {
                select.append('<button type="button" data-id="0"  class="layui-btn layui-btn-primary layui-btn-sm ">全部Discord账号</button>');
            }else{
                select.append('<button type="button" data-id="0"  class="layui-btn  layui-btn-sm layui-btn-touyan">全部Discord账号</button>');
            }

            res.data.forEach(item => {
                const selected = (parseInt(item.id) === parseInt(did)) ? 'layui-btn-touyan' : 'layui-btn-primary';
                console.log(item.id+'----'+ did);
                select.append(`<button type="button" data-id="${item.id}" class="layui-btn  layui-btn-sm  ${selected}"> ${item.global_name}</button>`);
            });

          } else {
            //layer.msg('下拉数据加载失败');
          }
        },
        error: function() {
          //layer.msg('请求出错');
        }
      });
  }




  fetchData(1, 10,{{did}});  // 默认加载第1页，10条数据
  setTimeout(getCategory, 300);
});





layui.use(function(){
  var $ = layui.$;
  var layer = layui.layer;
  var util = layui.util;
  var form = layui.form;

  const token = localStorage.getItem('token');


  // 事件
  util.on('lay-on', {
    'del-discord-confirm': function(){
      const id = $(this).data('id');       // 获取 data-id 的值

        layer.confirm('你确定移除此信息？', {
        btn: ['确定', '取消'] //按钮
      }, function(){
        // 此处可执行 Ajax 等操作
        $.ajax({
                url:'{{ url_for('discord.delete_channel') }}',
                data:{
                    "id":id,
                },
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){
                        $('#del_discord_'+id).remove();
                        layer.closeAll();
                        layer.msg(result.message);
                        // 重新拉取数据
                        fetchData(1, 10,{{did}});  // 默认加载第1页，10条数据
                        return true
                    }else{
                    	layer.msg(result.message);
                    	return false
                    }
                }
        })


      }, function(){
            return true

      });
    },
    'add-channel-confirm': function(){

      const id = $(this).data('id');       // 获取 data-id 的值
      const discord_token = $(this).data('discord-token');       // 获取 data-discord_token 的值
      const title = $(this).data('title');       // 获取 data-title 的值

      layer.open({
        type: 1,
        area: '350px',
        resize: false,
        shadeClose: true,
        title: '新增 '+title+' 账号的频道',
        content: `
          <div class="layui-form" lay-filter="filter-test-layer" style="margin: 16px;">
            <div class="demo-login-container">

            <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-link"></i>
                  </div>
                  <input type="text" name="discord_url" id="edit-discord-input" value="" lay-verify="required" placeholder="复制Discord URL到这里会自动取信息 " lay-reqtext="请填写Discord的链接URL" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
                <div class="layui-inline layui-word-aux layui-font-gray" style="font-size:12px;margin-bottom:0px;"   id="show-channel-demo-base-text">
                  什么？不知道Discord URL是哪个链接？
                  <a href="javascript:;" class="layui-font-blue">
                    点击查看教程
                  </a>
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-menu-fill"></i>
                  </div>
                  <input type="text" name="username" id="edit-username"   value="" lay-verify="required" placeholder="Discord频道名称" lay-reqtext="请填写频道名称" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-group"></i>
                  </div>
                  <input type="text" name="guild_id" id="edit-guild"   value="" lay-verify="required" placeholder="Discord服务器ID" lay-reqtext="请填写Discord服务器ID" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-reply-fill"></i>
                  </div>
                  <input type="text" name="channel_id" id="edit-channel"   value="" lay-verify="required" placeholder="Discord频道ID" lay-reqtext="请填写Discord频道ID" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>


              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-password"></i>
                  </div>
                    <textarea placeholder="请输入此频道备注" id="edit-remark"  name="remark" class="layui-textarea" lay-verify="required"  lay-reqtext="请填写频道备注"  ></textarea>
                    <input type="hidden" name="did" value="${id}" lay-verify="required"  autocomplete="off" >
                    <input type="hidden" name="guild_name" id="guild_name" value=""   autocomplete="off" >
                    <input type="hidden" name="guild_icon" id="guild_icon" value=""   autocomplete="off" >
                    <input type="hidden" name="guild_description" id="guild_description" value=""  autocomplete="off" >
                    <input type="hidden" name="discord_token" id="my_discord_token" value="${discord_token}"  autocomplete="off" >
                 </div>
              </div>

              <div class="layui-form-item">

                <button class="layui-btn layui-btn-fluid" id="add-button" lay-submit lay-filter="demo-login">确定提交</button>
              </div>

            </div>
          </div>
        `,
        success: function(){
          // 对弹层中的表单进行初始化渲染
          form.render();

          // 表单提交事件
          form.on('submit(demo-login)', function(data){

            $("#add-button").html("请稍等，正在提交数据...").attr("disabled","disabled");
            // 此处可执行 Ajax 等操作
            $.ajax({
                url:'{{ url_for('discord.add_channel') }}',
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                data:{
                    "username":data.field.username,
                    "did":data.field.did,
                    "token":data.field.discord_token,
                    "url":data.field.discord_url,
                    "remark":data.field.remark,
                    "guild_id":data.field.guild_id,
                    "guild_name":data.field.guild_name,
                    "guild_description":data.field.guild_description,
                    "guild_icon":data.field.guild_icon,
                    "channel_id":data.field.channel_id
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){

<!--                        layer.confirm(result.message, {-->
<!--                          btn: ['确定', '关闭'] //按钮-->
<!--                        }, function(){-->
<!--                          window.location.href='/discord/guild';-->
<!--                        }, function(){-->
<!--                          window.location.href='/discord/guild';-->
<!--                        });-->

                        layer.closeAll();
                        layer.msg(result.message);
                        // 重新拉取数据
                        fetchData(1, 10,{{did}});  // 默认加载第1页，10条数据

                        return true

                    }else{
                    	$("#add-button").html("确定提交").removeAttr("disabled");
                    	return layer.msg(result.message);
                    }
                }
            })
            return false; // 阻止默认 form 跳转
          });
        }
      });
    },
    'edit-confirm': function(){

      const id = $(this).data('id');
      const did = $(this).data('did');
      const username = $(this).data('username');
      const remark = $(this).data('remark');
      const discord_token = $(this).data('discord-token');
      const guild_id = $(this).data('guild-id');
      const guild_name = $(this).data('guild-name');
      const guild_icon = $(this).data('guild-icon');
      const guild_description = $(this).data('guild-description');
      const channel_id = $(this).data('channel-id');
      const url = $(this).data('url');

      layer.open({
        type: 1,
        area: '350px',
        resize: false,
        shadeClose: true,
        title: '修改'+username+'监控频道',
        content: `
            <div class="layui-form" lay-filter="filter-test-layer" style="margin: 16px;">
            <div class="demo-login-container">

            <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-link"></i>
                  </div>
                  <input type="text" name="discord_url" id="edit-discord-input" value="${url}" lay-verify="required" placeholder="复制Discord URL到这里会自动取信息 " lay-reqtext="请填写Discord的链接URL" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-menu-fill"></i>
                  </div>
                  <input type="text" name="username" id="edit-username"   value="${username}" lay-verify="required" placeholder="Discord频道名称" lay-reqtext="请填写频道名称" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-group"></i>
                  </div>
                  <input type="text" name="guild_id" id="edit-guild"   value="${guild_id}" lay-verify="required" placeholder="Discord服务器ID" lay-reqtext="请填写Discord服务器ID" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-reply-fill"></i>
                  </div>
                  <input type="text" name="channel_id" id="edit-channel"   value="${channel_id}" lay-verify="required" placeholder="Discord频道ID" lay-reqtext="请填写Discord频道ID" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>


              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-password"></i>
                  </div>
                    <textarea placeholder="请输入此频道备注" id="edit-remark"  name="remark" class="layui-textarea" lay-verify="required"  lay-reqtext="请填写频道备注"  >${remark}</textarea>
                    <input type="hidden" name="id" value="${id}" lay-verify="required"  autocomplete="off" >
                    <input type="hidden" name="did" value="${did}" lay-verify="required"  autocomplete="off" >
                    <input type="hidden" name="guild_name" id="guild_name" value="${guild_name}"   autocomplete="off" >
                    <input type="hidden" name="guild_icon" id="guild_icon" value="${guild_icon}"   autocomplete="off" >
                    <input type="hidden" name="guild_description" id="guild_description" value="${guild_description}"  autocomplete="off" >
                    <input type="hidden" name="discord_token" id="my_discord_token" value="${discord_token}"  autocomplete="off" >
                 </div>
              </div>

              <div class="layui-form-item">

                <button class="layui-btn layui-btn-fluid" id="add-button" lay-submit lay-filter="demo-login">确定修改</button>
              </div>

            </div>
          </div>
        `,
        success: function(){
          // 对弹层中的表单进行初始化渲染
          form.render();


          // 表单提交事件
          form.on('submit(demo-login)', function(data){

            $("#add-button").html("请稍等，正在提交数据...").attr("disabled","disabled");
            // 此处可执行 Ajax 等操作
            $.ajax({
                url:'{{ url_for('discord.edit_channel') }}',
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                data:{
                    "id":data.field.id,
                    "username":data.field.username,
                    "did":data.field.did,
                    "token":data.field.discord_token,
                    "url":data.field.discord_url,
                    "remark":data.field.remark,
                    "guild_id":data.field.guild_id,
                    "guild_name":data.field.guild_name,
                    "guild_description":data.field.guild_description,
                    "guild_icon":data.field.guild_icon,
                    "channel_id":data.field.channel_id
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){

<!--                        layer.confirm(result.message, {-->
<!--                          btn: ['确定', '关闭'] //按钮-->
<!--                        }, function(){-->
<!--                          window.location.href='/discord/guild';-->
<!--                        }, function(){-->
<!--                          window.location.href='/discord/guild';-->
<!--                        });-->
                        layer.closeAll();
                        layer.msg(result.message);
                        // 重新拉取数据
                        fetchData(1, 10,{{did}});  // 默认加载第1页，10条数据

                        return true

                    }else{
                    	$("#add-button").html("确定修改").removeAttr("disabled");
                    	return layer.msg(result.message);
                    }
                }
            })
            return false; // 阻止默认 form 跳转
          });
        }
      });
    },
    'add-discord-page-custom': function(){
      layer.open({
        type: 1,
        area: '350px',
        resize: false,
        shadeClose: true,
        title: '新增Discord账号',
        content: `
          <div class="layui-form" lay-filter="filter-test-layer" style="margin: 16px;">
            <div class="demo-login-container">

             <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-menu-fill"></i>
                  </div>
                  <input type="text" name="discord_token" id="add-token-input" value="" lay-verify="required" placeholder="Discord Token值会自动取信息 " lay-reqtext="请填写Discord的Token值" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-username"></i>
                  </div>
                  <input type="text" name="username" id="add-username"   value="" lay-verify="required" placeholder="@Discord用户名" lay-reqtext="请填写Discord用户名" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

             <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-list"></i>
                  </div>
                    <select name="category_id" id="category_select" lay-verify="required" lay-search>
                      <option value="">直接选择或搜索分组</option>
                    </select>
                    </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-password"></i>
                  </div>
                    <textarea placeholder="请输入此Discord备注" id="add-remark"   name="remark" class="layui-textarea" lay-verify="required"  lay-reqtext="请填写Discord备注"  ></textarea>
                     <input type="hidden" name="email" id="add-email"   value=""   autocomplete="off" >
                 </div>
              </div>

              <div class="layui-form-item">
                <button class="layui-btn layui-btn-fluid" id="add-button" lay-submit lay-filter="demo-login">确定增加</button>
              </div>

            </div>
          </div>
        `,
        success: function(){
          // 对弹层中的表单进行初始化渲染
          form.render();
           // Step 2: 异步加载下拉数据
          $.ajax({
            url:'{{ url_for('category.list_data') }}',// ✅ 你后端接口地址
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            type: 'GET',
            data: { is_type: 2 },
            success: function(res) {
              if (res.status === 1 && Array.isArray(res.data)) {
                const select = $('#category_select');
                select.empty();  // 清空旧内容
                select.append('<option value="">直接选择或搜索选择</option>');
                res.data.forEach(item => {
                  select.append(`<option value="${item.id}">${item.title}</option>`);
                });
                form.render('select');  // ⭐ 重要：重新渲染 layui select
              } else {
                //layer.msg('下拉数据加载失败');
              }
            },
            error: function() {
              //layer.msg('请求出错');
            }
          });
          // 表单提交事件
          form.on('submit(demo-login)', function(data){

            $("#add-button").html("请稍等，正在提交数据...").attr("disabled","disabled");
            // 此处可执行 Ajax 等操作
            $.ajax({
                url:'{{ url_for('discord.add') }}',
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                data:{
                    "username":data.field.username,
                    "cid":data.field.category_id,
                    "email":data.field.email,
                    "token":data.field.discord_token,
                    "remark":data.field.remark
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){

                        layer.confirm(result.message, {
                          btn: ['确定', '关闭'] //按钮
                        }, function(){
                          window.location.href='{{ url_for('discord.index') }}';
                        }, function(){
                          window.location.href='{{ url_for('discord.index') }}';
                        });

                        return true

                    }else{
                    	$("#add-button").html("确定提交").removeAttr("disabled");
                    	return layer.msg(result.message);
                    }
                }
            })
            return false; // 阻止默认 form 跳转
          });
        }
      });
    },
    'add-category-page-custom': function(){
      layer.open({
        type: 1,
        area: '350px',
        resize: false,
        shadeClose: true,
        title: '新增分组',
        content: `
          <div class="layui-form" lay-filter="filter-test-layer" style="margin: 16px;">
            <div class="demo-login-container">
              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-username"></i>
                  </div>
                  <input type="text" name="username" value="" lay-verify="required" placeholder="分组名称" lay-reqtext="请填写分组名称" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>
              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-password"></i>
                  </div>
                    <textarea placeholder="请输入此分组备注" name = "remark" class="layui-textarea" lay-verify="required"  lay-reqtext="请填写分组备注"  ></textarea>
                 </div>
              </div>

              <div class="layui-form-item">
                <button class="layui-btn layui-btn-fluid" id="add-button" lay-submit lay-filter="demo-login">确定增加</button>
              </div>

            </div>
          </div>
        `,
        success: function(){
          // 对弹层中的表单进行初始化渲染
          form.render();
          // 表单提交事件
          form.on('submit(demo-login)', function(data){

            $("#add-button").html("请稍等，正在提交数据...").attr("disabled","disabled");
            // 此处可执行 Ajax 等操作
            $.ajax({
                url:'{{ url_for('category.add') }}',
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                data:{
                    "username":data.field.username,
                    "remark":data.field.remark
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){

                        layer.confirm(result.message, {
                          btn: ['确定', '关闭'] //按钮
                        }, function(){
                          window.location.href='{{ url_for('discord.index') }}';
                        }, function(){
                          window.location.href='{{ url_for('discord.index') }}';
                        });

                        return true

                    }else{
                    	$("#add-button").html("确定提交").removeAttr("disabled");
                    	return layer.msg(result.message);
                    }
                }
            })
            return false; // 阻止默认 form 跳转
          });
        }
      });
    }
  })
});
</script>

{% endblock %}