{% extends "base.html" %}

{% block content %}
<style>
.flow-demo {
  height: 70vh;
  overflow: auto;
  font-size: 0;
}

.flow-demo li {
  display: block;              /* 改为块级元素，一整行显示 */
  width: 100%;                 /* 占满整行 */
  margin: 0 0 10px 0;          /* 只设置下边距，左右无空隙 */
  font-size: 14px;
  text-align: left;
}


/* 卡片整体容器 */
.messaget-card {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 10px;

  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* 头部：头像 + 标题区域在一行 */
.messaget-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* logo头像 */
.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

/* 标题和时间的容器（在 logo 右侧垂直排列） */
.messaget-card-title-group {
  display: flex;
  flex-direction: column;
}

/* 消息标题 */
.messaget-card-title {
  font-weight: bold;
  font-size: 20px;
  line-height: 1.2;
}

/* 发布时间 */
.messaget-card-time {
  font-size: 12px;
  color: #999;
  margin-top: 2px;
}

/* 英文消息 */
.message-en {
  margin-left: 55px;
  font-size: 16px;
}

/* 中文消息，左边加“译”标识 */
.message-zh {
  font-size: 14px;
  color: #666;
  margin-top:10px;
  padding-left: 55px;
  position: relative;
}

.message-zh::before {
  content: "译";
  position: absolute;
  left: 0;
  top: 0;
  font-size: 12px;
  background-color: #666;
  color: white;
  border-radius: 3px;
  padding: 1px 4px;
}
.msg-link {
    color: #16b777;
    text-decoration: underline;
}
</style>
 <!--begin::App Content Header-->
         <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6"><h4 class="mb-0">Discord监控面版</h4></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item active" aria-current="page">
                      <a href="{{ url_for('discord.guild') }}" >
                        <button type="button" class="layui-btn">查看全部监控频道</button>
                      </a>
                  </li>
                </ol>
              </div>
            </div>

            <div class="layui-btn-container" id="category_html">

            </div>

            <div class="layui-btn-container" id="guild_html">

            </div>

            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">



            <div class="row">
              <div class="flow-demo" id="ID-flow-demo"></div>

            </div>


          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->

<script>

// 翻译函数（Google Translate 非官方接口）
async function translateToZh(text) {
  const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`);
  const data = await res.json();
  return data[0].map(item => item[0]).join('');
}

function formatContent(content) {
  return content
    .replace(/<([^>\s]+)>/g, '$1') // 去掉尖括号
    .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color: #16b777; text-decoration: underline;">$1</a>') // 设置颜色和下划线
    .replace(/\n/g, "<br>");
}

layui.use(['flow', 'jquery'], function(){
  var flow = layui.flow;
  var $ = layui.jquery;
  const token = localStorage.getItem('token');
  let  guild_id = BigInt("{{gid}}");
  let  did = 0;
  localStorage.setItem('message_did', did);
  localStorage.setItem('message_guild', guild_id);

  function fetchMessage(page, limit, did,guild_id){

      flow.load({
        elem: '#ID-flow-demo',
        scrollElem: '#ID-flow-demo',
        done: function(page, next){
          if (guild_id<0) {
            let  guild_id = BigInt("{{gid}}");
          }else{
             guild_id = localStorage.getItem('message_guild');
          }

          console.log('guild_id+----'+ guild_id);
          $.ajax({
            url: '{{ url_for('discord.page_messages') }}',
            type: 'GET',
            data: { page: page, did: did,guild_id: guild_id,  limit: 10 },
            dataType: 'json',
            headers: {
            'Authorization': 'Bearer ' + token,
            },
            success: function(res){
              var lis = [];
              // 假设后端返回 res.data 是数组，res.total_pages 是总页数
              $.each(res.data, function(index, item){
                  const contentEn = item.content || '';
                  const contentHtml = formatContent(item.content || '');
                  const contentId = `content-cn-${item.id || Math.random().toString(36).substr(2, 8)}`;
                   // 判断是否是最近一天的消息
                  const now = Date.now();
                  const msgTime = new Date(item.timestamp).getTime();  // 注意这里时间格式要能被解析
                  const isRecent = (now - msgTime) <= 48 * 60 * 60 * 1000; // 24小时内

                lis.push(`
                  <li >
                      <div class="messaget-card">
                        <div class="messaget-card-header">
                          <img class="avatar" src="https://cdn.discordapp.com/icons/${item.guild_id}/${item.guild_icon}.png" alt="logo">
                          <div class="messaget-card-title-group">
                            <div class="messaget-card-title" >${item.guild_name} ${item.username} 账号:${item.discord_name} ${isRecent ? '<span class="new-tag" style="color:red;font-size:12px;" > <i class="layui-icon layui-icon-sound" style="font-size: 30px; color: #1E9FFF;"></i>最近48小时内新消息</span>' : ''} </div>
                            <div class="messaget-card-time"> ${item.timestamp} </div>
                          </div>
                        </div>
                        <div class="message-en" >${contentHtml}</div>
                        <div class="message-zh" id="${contentId}">翻译中...</div>
                      </div>
                    </li>
                `);

                  // 异步翻译并填入对应位置
                  translateToZh(contentEn).then(result => {
                    document.getElementById(contentId).innerText = result;
                  }).catch(() => {
                    //document.getElementById(contentId).innerText = '翻译失败';
                  });
              });
              // 判断是否还有下一页
              next(lis.join(''), page < res.count);
            },
            error: function(){
              // 请求失败时提示并结束加载
              next('', false);
            }
          });
        }
      });
  }


  // 监听分类按钮点击
  $('#category_html').on('click', '.layui-btn', function() {
    did = $(this).data('id');
    // 样式切换：移除其他按钮的 cur，添加当前按钮的 cur
    $('#category_html .layui-btn').addClass('layui-btn-primary');
    $(this).removeClass('layui-btn-primary');
    $('#ID-flow-demo').html('');  // 清空当前内容
    const message_guild = localStorage.getItem('message_guild');
    localStorage.setItem('message_did', did);
    //加载数据
    fetchMessage(1,10,did,message_guild)// 点击分类时重置为第一页
  });

   // 监听分类按钮点击
  $('#guild_html').on('click', '.layui-btn', function() {
    guild_id = $(this).data('id');
     console.log('guild_id:@@@----'+ guild_id);
    // 样式切换：移除其他按钮的 cur，添加当前按钮的 cur
    $('#guild_html .layui-btn').addClass('layui-btn-primary');
    $(this).removeClass('layui-btn-primary');
    $('#ID-flow-demo').html('');  // 清空当前内容
    //加载数据
    const did = localStorage.getItem('message_did');
    localStorage.setItem('message_guild', guild_id);
     console.log('guild_id:###----'+ guild_id);
    fetchMessage(1,10,did,guild_id)// 点击分类时重置为第一页
  });


  // ✅ 取到频道列表
  function getGuild(){
       let gid = BigInt("{{gid}}");
       const token = localStorage.getItem('token');
       $.ajax({
        url:'{{ url_for('discord.guild_data') }}',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        type: 'GET',
        success: function(res) {
          if (res.status === 1 && Array.isArray(res.data)) {
            const select = $('#guild_html');
            select.empty();  // 清空旧内容
            if (gid>0) {
                select.append('<button type="button" data-id="0"  class="layui-btn layui-btn-primary layui-btn-sm ">全部Discord服务器</button>');
            }else{
                select.append('<button type="button" data-id="0"  class="layui-btn  layui-btn-sm ">全部Discord服务器</button>');
            }


            res.data.forEach(item => {
                const selected = (BigInt(item.guild_id) === BigInt(gid)) ? '' : 'layui-btn-primary';
                console.log(item.guild_id+'----'+ gid);
                select.append(`<button type="button" data-id="${item.guild_id}" class="layui-btn  layui-btn-sm  ${selected}"> ${item.guild_name}</button>`);
            });

          } else {
            layer.msg('下拉数据加载失败');
          }
        },
        error: function() {
          layer.msg('请求出错');
        }
      });
  }

    // ✅ 取到分类列表
  function getCategory(){
       const  did = 0;
       const token = localStorage.getItem('token');
       $.ajax({
        url:'{{ url_for('discord.list') }}',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        type: 'GET',
        data: { is_type: 2 },
        success: function(res) {
          if (res.status === 1 && Array.isArray(res.data)) {
            const select = $('#category_html');
            select.empty();  // 清空旧内容
            if (did>0) {
                select.append('<button type="button" data-id="0"  class="layui-btn layui-btn-primary layui-btn-sm ">全部Discord账号</button>');
            }else{
                select.append('<button type="button" data-id="0"  class="layui-btn  layui-btn-sm ">全部Discord账号</button>');
            }


            res.data.forEach(item => {
                const selected = (parseInt(item.id) === parseInt(did)) ? '' : 'layui-btn-primary';
                console.log(item.id+'----'+ did);
                select.append(`<button type="button" data-id="${item.id}" class="layui-btn  layui-btn-sm  ${selected}"> ${item.global_name}</button>`);
            });

          } else {
            layer.msg('下拉数据加载失败');
          }
        },
        error: function() {
          layer.msg('请求出错');
        }
      });
  }

  function updateMessage() {
        const did = 0;
        const token = localStorage.getItem('token');

        // 获取上次更新时间
        const lastUpdateTime = localStorage.getItem('updatetime');
        const now = Date.now();

        // 如果在1小时内，跳过请求
        if (lastUpdateTime && (now - parseInt(lastUpdateTime) < 60 * 60 * 1000)) {
            console.log('🔁 距离上次更新时间未超过2小时，跳过请求');
            return;
        }

        // 发起请求
        $.ajax({
            url: '/api/auth/update_message',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            type: 'GET',
            data: {},
            success: function (res) {
                if (res.status === 1) {
                    // 成功后更新 updatetime
                    localStorage.setItem('updatetime', Date.now().toString());
                    console.log('🔁 更新时间'+Date.now().toString());
                }
            },
            error: function () {
                console.log('请求出错');
            }
        });
    }


   //加载数据
  fetchMessage(1,10,0,0)

   //主动更新信息
  setTimeout(updateMessage, 800);

   //取到分类更新信息
  setTimeout(getCategory, 300);

   //取到服务器信息
  setTimeout(getGuild, 500);

});
</script>
{% endblock %}