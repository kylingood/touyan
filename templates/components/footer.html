
<style>
  .footer-container {
    display: flex;
    justify-content: space-between; /* å·¦å³åˆ†å¸ƒï¼Œå¯é€‰ */
    align-items: center;            /* å‚ç›´å±…ä¸­ï¼Œå¯é€‰ */
    flex-wrap: wrap;                /* è®©å®ƒåœ¨å°å±ä¸‹è‡ªåŠ¨æ¢è¡Œ */
    gap: 10px;                      /* æ§åˆ¶ä¸¤ä¸ª div é—´çš„é—´è· */
  }
</style>

<!--begin::Footer-->
      <footer class="app-footer">
        <!--begin::To the end-->
       <div class="footer-container">

         <div class="layui-form ws-header-theme" lay-filter="header-theme" >
          <input type="checkbox" name="theme-mode" id="ID-header-theme-mode" lay-filter="header-theme-mode" lay-skin="switch">
          <div lay-checkbox>
            <i class="layui-icon layui-icon-moon"></i> |
            <i class="layui-icon layui-icon-light"></i>
          </div>
         </div>


        <div class="float-end d-none d-sm-inline">
        <span>TouYan.me åªæ˜¯ä¸€ä¸ª Web3 ä¿¡æ¯èšåˆå·¥å…·ã€‚è¯·æ‚¨è°¨è®°ï¼šæŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚</span>
        </div>
        <!--end::To the end-->
        <!--begin::Copyright-->

        <div>
        <strong>
          Copyright &copy; 2024-2025&nbsp;
          <a href="https://x.com/guzibiji" class="text-decoration-none">Guzi</a>.
        </strong>
        All rights reserved.
        <!--end::Copyright-->
        </div>
            </div>
      </footer>
      <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script-->

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script src="{{ url_for('static', filename='dist/js/adminlte.js') }}"></script>
    <!--end::Required Plugin(AdminLTE)--><!--begin::OverlayScrollbars Configure-->

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>


    <!--end::OverlayScrollbars Configure-->
    <!-- OPTIONAL SCRIPTS -->

<script>
var laypage = layui.laypage;
var $ = layui.jquery;



$(document).ready(function() {
    const token = localStorage.getItem('token');

     $.ajax({
      url: '/api/get_user_info',
      method: 'GET',
      headers: {
            'Authorization': 'Bearer ' + token
      },
      success: function(res) {
        if (res.status === 1) {
          // åˆ¤æ–­æ˜¯å¦ç®¡ç†å‘˜
            $('.sidebar-menu').append(`
              <li class="nav-item">
                 <a href="{{ url_for('member.index') }}" class="nav-link {% if request.path.startswith('/member/index') %}active{% endif %}">
                  <i class="nav-icon layui-icon layui-icon-group"></i>
                  <p>ä¼šå‘˜ç®¡ç†</p>
                </a>
              </li>

              <li class="nav-item">
                 <a href="{{ url_for('member.codes') }}" class="nav-link {% if request.path.startswith('/member/codes') %}active{% endif %}">
                  <i class="nav-icon layui-icon layui-icon-tabs"></i>
                  <p>é‚€è¯·ç ç®¡ç†</p>
                </a>
              </li>
            `);

        } else {
          console.log('æœªç™»å½•æˆ–æƒé™ä¸è¶³');
        }
      },
      error: function() {
        console.log('æ¥å£è¯·æ±‚å¤±è´¥');
      }
    });

});


async function loginWithWallet() {
  if (typeof window.ethereum === 'undefined') {
    layer.msg("è¯·å®‰è£… MetaMask æˆ– OKX é’±åŒ…");
    return;
  }

  const web3 = new Web3(window.ethereum);

  try {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const address = accounts[0];

    // 1. è·å–åç«¯ç­¾åæ¶ˆæ¯
    const msgRes = await fetch(`/api/auth/message?address=${address}`);
    const { message, exists } = await msgRes.json(); // å‡è®¾åç«¯è¿”å›æ˜¯å¦å·²æ³¨å†Œ exists

    // 2. ç”¨æˆ·ç­¾åæ¶ˆæ¯
    const signature = await web3.eth.personal.sign(message, address, '');

    // 3. åˆ¤æ–­æ˜¯å¦å·²æ³¨å†Œï¼Œå¦‚æœæ²¡æœ‰æ³¨å†Œåˆ™æç¤ºå¡«å†™é‚€è¯·ç 
    let inviteCode = null;
    if (!exists) {
      await new Promise((resolve, reject) => {
      layer.prompt({
        title: 'è¯·è¾“å…¥é‚€è¯·ç å†è¿›è¡Œæ³¨å†Œ',
        formType: 0,
        btn: ['ç¡®å®š', 'å–æ¶ˆ']
      }, function (value, index) {
        inviteCode = value;
        if (!inviteCode) {
          layer.msg("å¿…é¡»è¾“å…¥é‚€è¯·ç æ‰èƒ½æ³¨å†Œ");
          return;
        }

        // å¼‚æ­¥æ£€æŸ¥é‚€è¯·ç 
        fetch(`/api/auth/check_invite?code=${encodeURIComponent(inviteCode)}`)
          .then(res => res.json())
          .then(data => {
            if (data.valid) {
              layer.close(index);
              resolve(); // éªŒè¯é€šè¿‡ï¼Œç»§ç»­æµç¨‹
            } else {
              layer.msg(data.message);
              return;
            }
          })
          .catch(err => {
            layer.msg("éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            return;
          });
      });
    });

    }

    // 4. éªŒè¯ç­¾åå¹¶ç™»å½•ï¼ˆå¸¦é‚€è¯·ç ï¼‰
    const verifyRes = await fetch('/api/auth/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address, message, signature, inviteCode })
    });

    const verifyData = await verifyRes.json();

    if (verifyRes.ok && verifyData.token) {
      localStorage.setItem('token', verifyData.token);
      layer.msg('ç™»å½•æˆåŠŸï¼');
      setTimeout(() => {
        location.reload();
      }, 500);
    } else {
      layer.msg('ç™»å½•å¤±è´¥: ' + (verifyData.error || 'æœªçŸ¥é”™è¯¯'));
    }

  } catch (err) {
    console.error(err);
    layer.msg('å‘ç”Ÿé”™è¯¯: ' + err.message);
  }
}




async function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const loginContainer = document.getElementById('login_html');

      if (!loginContainer) return; // é˜²æ­¢é¡µé¢æ²¡æœ‰è¿™ä¸ªå…ƒç´ æ—¶æŠ¥é”™

      if (!token) {
        // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æŒ‰é’®
        loginContainer.innerHTML = `
           <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" onclick="loginWithWallet()">ğŸ” è¯·ç”¨EVMé’±åŒ…ç™»å½•</button>
        `;
        return;
      }

      try {
        const res = await fetch('/api/protected', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (res.ok) {
          const data = await res.json();
          // ç™»å½•æˆåŠŸï¼šæ˜¾ç¤ºç”¨æˆ·å¤´åƒ
          loginContainer.innerHTML = `
            <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" onclick="logout()">æ¬¢è¿ï¼š${data.username}   ğŸ”“ç‚¹å‡»é€€å‡º</button>
           `;
        } else {
          throw new Error('æ— æ•ˆ token');
        }
      } catch (error) {
        console.log('Token æ— æ•ˆæˆ–å·²è¿‡æœŸ');
        localStorage.removeItem('token');
        // æ˜¾ç¤ºç™»å½•æŒ‰é’®
        loginContainer.innerHTML = `
          <span class="d-none d-md-inline">
            <button type="button" class="btn btn-primary btn-sm" onclick="loginWithWallet()">ğŸ” ä½¿ç”¨é’±åŒ…ç™»å½•</button>
          </span>
        `;
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.addEventListener('DOMContentLoaded', checkLoginStatus);


   // é€€å‡ºç™»å½•ï¼ˆå¸¦ç¡®è®¤æç¤ºï¼‰
    function logout() {
      layer.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', { icon: 3, title: 'æç¤º' }, function(index) {
          localStorage.removeItem('token');
          checkLoginStatus(); // åˆ·æ–°ç™»å½•çŠ¶æ€ UI
          layer.msg('é€€å‡ºæˆåŠŸï¼', { time: 1000 }, function() {
          //location.reload(); // âœ… é€€å‡ºæˆåŠŸååˆ·æ–°å½“å‰é¡µé¢
          window.location.href='/';
        });
         layer.close(index);
      });
    }

layui.use(['form'], function() {
  const form = layui.form;

  // è·å–æœ¬åœ°ä¸»é¢˜
  const storedTheme = localStorage.getItem('theme');

  // è®¾ç½®ä¸»é¢˜å‡½æ•°
  function setTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
      document.documentElement.setAttribute('data-bs-theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.documentElement.setAttribute('data-bs-theme', 'light');
    }
    updateSidebarTheme(theme);
  }

  // ä¾§è¾¹æ ä¸»é¢˜åŒæ­¥
  function updateSidebarTheme(theme) {
    const sidebar = document.querySelector('.app-sidebar');
    if (!sidebar) return;

    if (theme === 'dark') {
      sidebar.classList.remove('bg-light');
    } else {
      sidebar.classList.add('bg-light');
    }
  }

  // åˆå§‹åŒ–ä¸»é¢˜
  const initTheme = storedTheme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
  setTheme(initTheme);

  // è®¾ç½®å¼€å…³çŠ¶æ€ï¼ˆå¦‚æœä½ æƒ³åŒæ­¥ switch çŠ¶æ€ï¼‰
  const switchElem = document.getElementById('ID-header-theme-mode');
  if (switchElem) {
    switchElem.checked = initTheme === 'dark';
  }

  // ç›‘å¬å¼€å…³åˆ‡æ¢
  form.on('switch(header-theme-mode)', function(data){
    const theme = data.elem.checked ? 'dark' : 'light';
    localStorage.setItem('theme', theme);
    setTheme(theme);
  });

  // å“åº”ç³»ç»Ÿæš—è‰²å˜åŒ–ï¼ˆå¯é€‰ï¼‰
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
    const autoTheme = e.matches ? "dark" : "light";
    const saved = localStorage.getItem('theme');
    if (saved !== 'light' && saved !== 'dark') {
      setTheme(autoTheme);
    }
  });
});
</script>


  </body>
  <!--end::Body-->
</html>
