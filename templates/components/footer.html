
<style>
  .footer-container {
    display: flex;
    justify-content: space-between; /* 左右分布，可选 */
    align-items: center;            /* 垂直居中，可选 */
    flex-wrap: wrap;                /* 让它在小屏下自动换行 */
    gap: 10px;                      /* 控制两个 div 间的间距 */
  }
</style>

<!--begin::Footer-->
      <footer class="app-footer">
        <!--begin::To the end-->
       <div class="footer-container">

         <div class="layui-form ws-header-theme" lay-filter="header-theme" >
          <input type="checkbox" name="theme-mode" id="ID-header-theme-mode" lay-filter="header-theme-mode" lay-skin="switch">
          <div lay-checkbox>
            <i class="layui-icon layui-icon-moon"></i> |
            <i class="layui-icon layui-icon-light"></i>
          </div>
         </div>


        <div class="float-end d-none d-sm-inline">
        <span>TouYan.me 只是一个 Web3 信息聚合工具。请您谨记：投资有风险，入市需谨慎。</span>
        </div>
        <!--end::To the end-->
        <!--begin::Copyright-->

        <div>
        <strong>
          Copyright &copy; 2024-2025&nbsp;
          <a href="https://x.com/guzibiji" class="text-decoration-none">Guzi</a>.
        </strong>
        All rights reserved.
        <!--end::Copyright-->
        </div>
            </div>
      </footer>
      <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script-->

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script src="{{ url_for('static', filename='dist/js/adminlte.js') }}"></script>
    <!--end::Required Plugin(AdminLTE)--><!--begin::OverlayScrollbars Configure-->

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>


    <!--end::OverlayScrollbars Configure-->
    <!-- OPTIONAL SCRIPTS -->

<script>
var laypage = layui.laypage;
var $ = layui.jquery;



$(document).ready(function() {
    const token = localStorage.getItem('token');

     $.ajax({
      url: '/api/get_user_info',
      method: 'GET',
      headers: {
            'Authorization': 'Bearer ' + token
      },
      success: function(res) {
        if (res.status === 1) {
          // 判断是否管理员
            $('.sidebar-menu').append(`
              <li class="nav-item">
                 <a href="{{ url_for('member.index') }}" class="nav-link {% if request.path.startswith('/member/index') %}active{% endif %}">
                  <i class="nav-icon layui-icon layui-icon-group"></i>
                  <p>会员管理</p>
                </a>
              </li>

              <li class="nav-item">
                 <a href="{{ url_for('member.codes') }}" class="nav-link {% if request.path.startswith('/member/codes') %}active{% endif %}">
                  <i class="nav-icon layui-icon layui-icon-tabs"></i>
                  <p>邀请码管理</p>
                </a>
              </li>
            `);

        } else {
          console.log('未登录或权限不足');
        }
      },
      error: function() {
        console.log('接口请求失败');
      }
    });

});


async function loginWithWallet() {
  if (typeof window.ethereum === 'undefined') {
    layer.msg("请安装 MetaMask 或 OKX 钱包");
    return;
  }

  const web3 = new Web3(window.ethereum);

  try {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const address = accounts[0];

    // 1. 获取后端签名消息
    const msgRes = await fetch(`/api/auth/message?address=${address}`);
    const { message, exists } = await msgRes.json(); // 假设后端返回是否已注册 exists

    // 2. 用户签名消息
    const signature = await web3.eth.personal.sign(message, address, '');

    // 3. 判断是否已注册，如果没有注册则提示填写邀请码
    let inviteCode = null;
    if (!exists) {
      await new Promise((resolve, reject) => {
      layer.prompt({
        title: '请输入邀请码再进行注册',
        formType: 0,
        btn: ['确定', '取消']
      }, function (value, index) {
        inviteCode = value;
        if (!inviteCode) {
          layer.msg("必须输入邀请码才能注册");
          return;
        }

        // 异步检查邀请码
        fetch(`/api/auth/check_invite?code=${encodeURIComponent(inviteCode)}`)
          .then(res => res.json())
          .then(data => {
            if (data.valid) {
              layer.close(index);
              resolve(); // 验证通过，继续流程
            } else {
              layer.msg(data.message);
              return;
            }
          })
          .catch(err => {
            layer.msg("验证失败，请稍后再试");
            return;
          });
      });
    });

    }

    // 4. 验证签名并登录（带邀请码）
    const verifyRes = await fetch('/api/auth/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address, message, signature, inviteCode })
    });

    const verifyData = await verifyRes.json();

    if (verifyRes.ok && verifyData.token) {
      localStorage.setItem('token', verifyData.token);
      layer.msg('登录成功！');
      setTimeout(() => {
        location.reload();
      }, 500);
    } else {
      layer.msg('登录失败: ' + (verifyData.error || '未知错误'));
    }

  } catch (err) {
    console.error(err);
    layer.msg('发生错误: ' + err.message);
  }
}




async function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const loginContainer = document.getElementById('login_html');

      if (!loginContainer) return; // 防止页面没有这个元素时报错

      if (!token) {
        // 未登录：显示登录按钮
        loginContainer.innerHTML = `
           <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" onclick="loginWithWallet()">🔐 请用EVM钱包登录</button>
        `;
        return;
      }

      try {
        const res = await fetch('/api/protected', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (res.ok) {
          const data = await res.json();
          // 登录成功：显示用户头像
          loginContainer.innerHTML = `
            <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" onclick="logout()">欢迎：${data.username}   🔓点击退出</button>
           `;
        } else {
          throw new Error('无效 token');
        }
      } catch (error) {
        console.log('Token 无效或已过期');
        localStorage.removeItem('token');
        // 显示登录按钮
        loginContainer.innerHTML = `
          <span class="d-none d-md-inline">
            <button type="button" class="btn btn-primary btn-sm" onclick="loginWithWallet()">🔐 使用钱包登录</button>
          </span>
        `;
      }
    }

    // 页面加载完成后执行
    window.addEventListener('DOMContentLoaded', checkLoginStatus);


   // 退出登录（带确认提示）
    function logout() {
      layer.confirm('确定要退出登录吗？', { icon: 3, title: '提示' }, function(index) {
          localStorage.removeItem('token');
          checkLoginStatus(); // 刷新登录状态 UI
          layer.msg('退出成功！', { time: 1000 }, function() {
          //location.reload(); // ✅ 退出成功后刷新当前页面
          window.location.href='/';
        });
         layer.close(index);
      });
    }

layui.use(['form'], function() {
  const form = layui.form;

  // 获取本地主题
  const storedTheme = localStorage.getItem('theme');

  // 设置主题函数
  function setTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
      document.documentElement.setAttribute('data-bs-theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.documentElement.setAttribute('data-bs-theme', 'light');
    }
    updateSidebarTheme(theme);
  }

  // 侧边栏主题同步
  function updateSidebarTheme(theme) {
    const sidebar = document.querySelector('.app-sidebar');
    if (!sidebar) return;

    if (theme === 'dark') {
      sidebar.classList.remove('bg-light');
    } else {
      sidebar.classList.add('bg-light');
    }
  }

  // 初始化主题
  const initTheme = storedTheme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
  setTheme(initTheme);

  // 设置开关状态（如果你想同步 switch 状态）
  const switchElem = document.getElementById('ID-header-theme-mode');
  if (switchElem) {
    switchElem.checked = initTheme === 'dark';
  }

  // 监听开关切换
  form.on('switch(header-theme-mode)', function(data){
    const theme = data.elem.checked ? 'dark' : 'light';
    localStorage.setItem('theme', theme);
    setTheme(theme);
  });

  // 响应系统暗色变化（可选）
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
    const autoTheme = e.matches ? "dark" : "light";
    const saved = localStorage.getItem('theme');
    if (saved !== 'light' && saved !== 'dark') {
      setTheme(autoTheme);
    }
  });
});
</script>


  </body>
  <!--end::Body-->
</html>
