<!--begin::Footer-->
      <footer class="app-footer">
        <!--begin::To the end-->
        <div class="float-end d-none d-sm-inline">Anything you want</div>
        <!--end::To the end-->
        <!--begin::Copyright-->
        <strong>
          Copyright &copy; 2024-2025&nbsp;
          <a href="https://x.com/guzibiji" class="text-decoration-none">Guzi</a>.
        </strong>
        All rights reserved.
        <!--end::Copyright-->
      </footer>
      <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script-->
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <script
      src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
      integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ="
      crossorigin="anonymous"
    ></script>
    <!--end::Third Party Plugin(OverlayScrollbars)--><!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)--><!--begin::Required Plugin(Bootstrap 5)-->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script src="{{ url_for('static', filename='dist/js/adminlte.js') }}"></script>
    <!--end::Required Plugin(AdminLTE)--><!--begin::OverlayScrollbars Configure-->

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

    <script>
      const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
      const Default = {
        scrollbarTheme: 'os-theme-light',
        scrollbarAutoHide: 'leave',
        scrollbarClickScroll: true,
      };
      document.addEventListener('DOMContentLoaded', function () {
        const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
        if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== 'undefined') {
          OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
            scrollbars: {
              theme: Default.scrollbarTheme,
              autoHide: Default.scrollbarAutoHide,
              clickScroll: Default.scrollbarClickScroll,
            },
          });
        }
      });
    </script>
    <!--end::OverlayScrollbars Configure-->
    <!-- OPTIONAL SCRIPTS -->

<script>
var laypage = layui.laypage;
var $ = layui.jquery;

$(document).ready(function() {
    const token = localStorage.getItem('token');

     $.ajax({
      url: '/api/get_user_info',
      method: 'GET',
      headers: {
            'Authorization': 'Bearer ' + token
      },
      success: function(res) {
        if (res.status === 1) {
          // åˆ¤æ–­æ˜¯å¦ç®¡ç†å‘˜
            $('.sidebar-menu').append(`
              <li class="nav-item">
                 <a href="{{ url_for('member.index') }}" class="nav-link {% if request.path.startswith('/member/index') %}active{% endif %}">
                  <i class="nav-icon layui-icon layui-icon-group"></i>
                  <p>ä¼šå‘˜ç®¡ç†</p>
                </a>
              </li>

              <li class="nav-item">
                 <a href="{{ url_for('member.codes') }}" class="nav-link {% if request.path.startswith('/member/codes') %}active{% endif %}">
                  <i class="nav-icon layui-icon layui-icon-tabs"></i>
                  <p>é‚€è¯·ç ç®¡ç†</p>
                </a>
              </li>
            `);

        } else {
          console.log('æœªç™»å½•æˆ–æƒé™ä¸è¶³');
        }
      },
      error: function() {
        console.log('æ¥å£è¯·æ±‚å¤±è´¥');
      }
    });

   });


async function loginWithWallet() {
  if (typeof window.ethereum === 'undefined') {
    layer.msg("è¯·å®‰è£… MetaMask æˆ– OKX é’±åŒ…");
    return;
  }

  const web3 = new Web3(window.ethereum);

  try {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const address = accounts[0];

    // 1. è·å–åç«¯ç­¾åæ¶ˆæ¯
    const msgRes = await fetch(`/api/auth/message?address=${address}`);
    const { message } = await msgRes.json();

    // 2. ç”¨æˆ·ç­¾åæ¶ˆæ¯
    const signature = await web3.eth.personal.sign(message, address, '');

    // 3. å‘é€ç­¾åå’Œåœ°å€åˆ°åç«¯éªŒè¯
    const verifyRes = await fetch('/api/auth/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address, message, signature })
    });

    const verifyData = await verifyRes.json();

    if (verifyRes.ok && verifyData.token) {
      // âœ… ä¿å­˜ token åˆ° localStorage
      localStorage.setItem('token', verifyData.token);
      layer.msg('ç™»å½•æˆåŠŸï¼');
      checkLoginStatus(); // åˆ·æ–°ç™»å½•çŠ¶æ€ UI
      location.reload(); // âœ… ç™»å½•æˆåŠŸååˆ·æ–°å½“å‰é¡µé¢

    } else {
      layer.msg('ç™»å½•å¤±è´¥: ' + (verifyData.error || 'æœªçŸ¥é”™è¯¯'));
    }

  } catch (err) {
    console.error(err);
    layer.msg('å‘ç”Ÿé”™è¯¯: ' + err.message);
  }
}




async function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const loginContainer = document.getElementById('login_html');

      if (!loginContainer) return; // é˜²æ­¢é¡µé¢æ²¡æœ‰è¿™ä¸ªå…ƒç´ æ—¶æŠ¥é”™

      if (!token) {
        // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æŒ‰é’®
        loginContainer.innerHTML = `
          <span class="d-none d-md-inline">
            <button type="button" class="btn btn-primary btn-sm" onclick="loginWithWallet()">ğŸ” ä½¿ç”¨é’±åŒ…ç™»å½•</button>
          </span>
        `;
        return;
      }

      try {
        const res = await fetch('/api/protected', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (res.ok) {
          const data = await res.json();
          // ç™»å½•æˆåŠŸï¼šæ˜¾ç¤ºç”¨æˆ·å¤´åƒ
          loginContainer.innerHTML = `
            <img
              src="/static/dist/assets/img/avatar5.png"
              class="user-image rounded-circle shadow"
              alt="User Image"
            />
            <ul class="dropdown-menu dropdown-menu-end">
            <!--begin::Menu Footer-->
            <li class="user-footer">
              <a href="#" class="btn btn-default btn-flat">ä¸ªäººèµ„æ–™</a>
              <a href="#" class="btn btn-default btn-flat float-end" onclick="logout()">é€€å‡º</a>
            </li>
            <!--end::Menu Footer-->
            </ul>

          `;
        } else {
          throw new Error('æ— æ•ˆ token');
        }
      } catch (error) {
        console.log('Token æ— æ•ˆæˆ–å·²è¿‡æœŸ');
        localStorage.removeItem('token');
        // æ˜¾ç¤ºç™»å½•æŒ‰é’®
        loginContainer.innerHTML = `
          <span class="d-none d-md-inline">
            <button type="button" class="btn btn-primary btn-sm" onclick="loginWithWallet()">ğŸ” ä½¿ç”¨é’±åŒ…ç™»å½•</button>
          </span>
        `;
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.addEventListener('DOMContentLoaded', checkLoginStatus);

    // é€€å‡ºç™»å½•
    function logout() {
      localStorage.removeItem('token');
      checkLoginStatus(); // åˆ·æ–°ç™»å½•çŠ¶æ€ UI
      layer.msg('é€€å‡ºæˆåŠŸï¼', { time: 1000 }, function() {
        location.reload(); // âœ… é€€å‡ºæˆåŠŸååˆ·æ–°å½“å‰é¡µé¢
      });

    }

layui.use(['form'], function() {
  const form = layui.form;

  // è·å–æœ¬åœ°ä¸»é¢˜
  const storedTheme = localStorage.getItem('theme');

  // è®¾ç½®ä¸»é¢˜å‡½æ•°
  function setTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
      document.documentElement.setAttribute('data-bs-theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.documentElement.setAttribute('data-bs-theme', 'light');
    }
    updateSidebarTheme(theme);
  }

  // ä¾§è¾¹æ ä¸»é¢˜åŒæ­¥
  function updateSidebarTheme(theme) {
    const sidebar = document.querySelector('.app-sidebar');
    if (!sidebar) return;

    if (theme === 'dark') {
      sidebar.classList.remove('bg-light');
    } else {
      sidebar.classList.add('bg-light');
    }
  }

  // åˆå§‹åŒ–ä¸»é¢˜
  const initTheme = storedTheme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
  setTheme(initTheme);

  // è®¾ç½®å¼€å…³çŠ¶æ€ï¼ˆå¦‚æœä½ æƒ³åŒæ­¥ switch çŠ¶æ€ï¼‰
  const switchElem = document.getElementById('ID-header-theme-mode');
  if (switchElem) {
    switchElem.checked = initTheme === 'dark';
  }

  // ç›‘å¬å¼€å…³åˆ‡æ¢
  form.on('switch(header-theme-mode)', function(data){
    const theme = data.elem.checked ? 'dark' : 'light';
    localStorage.setItem('theme', theme);
    setTheme(theme);
  });

  // å“åº”ç³»ç»Ÿæš—è‰²å˜åŒ–ï¼ˆå¯é€‰ï¼‰
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
    const autoTheme = e.matches ? "dark" : "light";
    const saved = localStorage.getItem('theme');
    if (saved !== 'light' && saved !== 'dark') {
      setTheme(autoTheme);
    }
  });
});
</script>


  </body>
  <!--end::Body-->
</html>
