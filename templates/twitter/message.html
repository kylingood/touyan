{% extends "base.html" %}

{% block content %}
<style>
video {
  display: block;
  margin-top: 10px; /* è°ƒæ•´ä¸ºä½ æƒ³è¦çš„æ¢è¡Œè·ç¦» */
}

.flow-demo {
  height: 70vh;
  overflow: auto;
  font-size: 0;
}

#ID-flow-demo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(780px, 1fr));
  gap: 16px;
  padding: 16px;
}

.tweet-container {
  max-width: 100%;
  width: 100%;
  margin: auto;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  padding: 16px;
}

/* æ¨æ–‡ä¸»å¸ƒå±€  border-bottom: 1px solid #e6ecf0; */
.tweet {
  display: flex;
  gap: 12px;

  padding-bottom: 12px;
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.content {
  flex: 1;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  margin-bottom: 4px;
}

.user-info {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.name {
  font-weight: 600;
  color: #16b777;
}

.handle, .timestamp {
  color: #666;
}

.view-link {
  color: #31bdec;
  text-decoration: none;
  font-size: 13px;
}

.text_content {
  font-size: 15px;
  margin: 8px 0;
}

/* å¼•ç”¨æ¨æ–‡ */
.quoted-tweet {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px;
}

.quoted-header {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}

.quoted-tweet .avatar {
  width: 32px;
  height: 32px;
}
.quoted-header {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}

.quoted-header .name {
  font-weight: 600;
  color: #16b777;
  font-size: 14px;
}

.quoted-header .handle,
.quoted-header .timestamp {
  color: #888;
  font-size: 13px;
  margin-left: 4px;
}

.quoted-header div {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 4px;
}

.quoted-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.quoted-header > div {
  flex-grow: 1; /* è®©ä¸­é—´ä¿¡æ¯å æ»¡å‰©ä½™ç©ºé—´ */
}

.quoted-header .view-link {

  color: #31bdec;
  text-decoration: none;
  font-size: 13px;
}


/* ä»ç¬¬äºŒå¼ å›¾èµ·ï¼Œæ¯å¼ å›¾å  50%ï¼Œè‡ªåŠ¨æ’å¸ƒæˆ 2 åˆ—  display: flex;*/
.text_content {

  flex-wrap: wrap;
  gap: 6px;
  align-items: flex-start;
}

.text_content > img {
  display: block;       /* å›¾ç‰‡ç‹¬å ä¸€è¡Œ */
  width: 50%;           /* å®½åº¦50% */
  border-radius: 8px;
  object-fit: cover;
  margin-top: 5px;
  margin-bottom: 5px;
}


/* æ‰‹æœºç«¯ï¼šæ¯è¡Œä¸€å¼ å›¾ */
@media (max-width: 600px) {
  .content > img {
    width: 100%;
  }
}

/* äº¤äº’æŒ‰é’®æ  */
.tweet-actions {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: #999;
  margin-top: 10px;
}

/* å“åº”å¼ */
@media (max-width: 600px) {
  .tweet {
    flex-direction: column;
  }

  .header {
    flex-direction: column;
    align-items: flex-start;
  }

  .tweet-actions {
    justify-content: space-around;
  }
}


.tweet-card-title {
  font-size: 16px;
  font-weight: bold;
  margin: 0 20px 10px 20px;
  font-family: Arial, sans-serif;
}

.tweet-card {
  width: 92%;
  border: 1px solid #e6e6e6;
  border-radius: 8px;
  padding: 12px;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  margin: 0 20px 20px 20px;
}

.sub-account {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    padding: 6px 0;
}

.sub-account .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid #ccc;
    flex-shrink: 0;
    margin: 0;
}

.sub-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin: 0;
    padding: 0;
}

.sub-name {
    font-weight: 700;
    font-size: 14px;
    color: #16b777;
    margin: 0;
    line-height: 1.1;
}

.sub-handle {
    font-size: 13px;
    color: #999;
    margin: 2px 0 0 0;
    line-height: 1.1;
}
.sub_avatar{
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #ccc;
}

.follow-btn {
    margin-left: auto;
    color: #999999;
    font-size: 12px;
    white-space: nowrap;
}

.divider {
  border: none;
  border-top: 1px solid #ccc;
  margin: 10px 15px;
}

.main-account {
  display: flex;
  align-items: flex-start;
}

.avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  margin-right: 10px;
  border: 2px solid #ccc;
}

.main-info {
  flex: 1;
}

.main-header {
  display: flex;
  align-items: center;
  line-height: 1.2;
  margin-bottom: 2px;
}

.main-header .name {
  font-weight: bold;
  font-size: 15px;
  color: #16b777;
}

.main-header .timestamp {
  font-size: 12px;
  color: #999;
  margin-left: 6px;
}

.handle {
  font-size: 13px;
  color: #999;
}

.description {
  margin: 4px 0;
  font-size: 14px;
  color: #444;
}

.timestamp {
  font-size: 12px;
  color: #999;
}


/* ä¸­æ–‡æ¶ˆæ¯ï¼Œå·¦è¾¹åŠ â€œè¯‘â€æ ‡è¯† */
.message-zh {
  font-size: 14px;
  color: red;
  margin:20px 0px 20px 0px;
  padding-left: 25px;
  position: relative;
}

.message-zh::before {
  content: "è¯‘";
  position: absolute;
  left: 0;
  top: 0;
  font-size: 12px;
  background-color: red;
  color: white;
  border-radius: 3px;
  padding: 1px 4px;
}
.msg-link {
    color: #16b777;
    text-decoration: underline;
}
</style>
 <!--begin::App Content Header-->
         <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6"><h4 class="mb-0">æ¨ç‰¹ä¿¡æ¯æµ</h4><span class="layui-font-gray">æ³¨æ„ï¼šç¬¬ä¸‰æ–¹æ¥å£é™åˆ¶ï¼Œç¬¬ä¸€æ¬¡æ–°å¢æ¨ç‰¹ï¼Œç³»ç»Ÿé¢„è®¡10åˆ†ç§å·¦å³æ›´æ–°æ•°æ®</span></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item active" aria-current="page">
                      <a href="{{ url_for('twitter.index') }}" >
                        <button type="button" class="layui-btn" style="background-color: #16b777 !important;" >æŸ¥çœ‹å…¨éƒ¨æ¨ç‰¹</button>
                      </a>
                  </li>
                </ol>
              </div>
            </div>

            <div class="layui-btn-container" id="category_html">

            </div>

            <div class="layui-btn-container" id="guild_html">

            </div>

            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">



            <div class="row">

              <div class="layui-row">
              <div class="layui-col-xs4 layui-col-sm7 layui-col-md8">
                <div class="grid-demo">
                    <div class="flow-demo" id="ID-flow-demo">


                    </div>

                </div>
              </div>
              <div class="layui-col-xs4 layui-col-sm5 layui-col-md4">
                <div class="grid-demo">
                <div class="tweet-card-title"><h4 class="mb-0">æœ€è¿‘å…³æ³¨</h4></div>

                <div class="flow-demo" id="ID-flow-followings">




                </div>



                </div>
              </div>
            </div>



            </div>


          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->

<script>



function formatContent(content) {
  return content
    .replace(/<([^>\s]+)>/g, '$1') // å»æ‰å°–æ‹¬å·
    .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color: #16b777; text-decoration: underline;">$1</a>') // è®¾ç½®é¢œè‰²å’Œä¸‹åˆ’çº¿
    .replace(/\n/g, "<br>");
}

function stripMediaTags(html) {
  return html
    .replace(/<img[^>]*>/gi, '')
    .replace(/<video[^>]*>.*?<\/video>/gis, '')
    .replace(/<audio[^>]*>.*?<\/audio>/gis, '')
    .replace(/<script[^>]*>.*?<\/script>/gis, '')
    .replace(/<style[^>]*>.*?<\/style>/gis, '')
    .replace(/<iframe[^>]*>.*?<\/iframe>/gis, '')
    .replace(/<(input|button|select|form)[^>]*>.*?<\/\1>/gis, '')
    .replace(/<(head|meta|link)[^>]*>/gi, '')
    .replace(/style="display:\s*none[^"]*"/gi, '')
    .replace(/<[^>]+>/g, '') // å¯é€‰ï¼šå»é™¤æ‰€æœ‰ HTML æ ‡ç­¾
    .replace(/\s+/g, ' ')     // å¤šä¸ªç©ºæ ¼å˜ä¸€ä¸ª
    .trim();
}

// ç¿»è¯‘å‡½æ•°ï¼ˆGoogle Translate éå®˜æ–¹æ¥å£ï¼‰
async function translateToZh(text) {
  const cleanText = stripMediaTags(text);
  const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(cleanText)}`);
  const data = await res.json();
  return data[0].map(item => item[0]).join('');
}

function formatTimestamp(unixTime) {
  const date = new Date(unixTime * 1000); // å¦‚æœæ˜¯æ¯«ç§’åˆ™ä¸ä¹˜
  const Y = date.getFullYear();
  const M = String(date.getMonth() + 1).padStart(2, '0');
  const D = String(date.getDate()).padStart(2, '0');
  const h = String(date.getHours()).padStart(2, '0');
  const m = String(date.getMinutes()).padStart(2, '0');
  return `${Y}/${M}/${D} ${h}:${m}`;
}

function linkifyShortUrls(text) {
  // æ­£åˆ™åŒ¹é… https://t.co/ åé¢è·Ÿä¸€ä¸²å­—æ¯æ•°å­—çš„çŸ­é“¾æ¥
  const urlRegex = /(https:\/\/t\.co\/[a-zA-Z0-9]+)/g;

  return text.replace(urlRegex, (match) => {
    return `<a href="${match}" target="_blank" style="color:#16b777;" rel="noopener noreferrer">${match}</a>`;
  });
}

layui.use(['flow', 'jquery'], function(){
  var flow = layui.flow;
  var $ = layui.jquery;
  const token = localStorage.getItem('token');
  let  guild_id = BigInt("{{gid}}");
  let  user_id = 0;
  localStorage.setItem('message_did', user_id);
  localStorage.setItem('message_guild', guild_id);


  function showBig(src) {
      layer.open({
        type: 1,
        title: false,
        area: ['auto', 'auto'],
        shadeClose: true,
        content: '<img src="' + src + '" style="max-width:100%; max-height:100%;" />'
      });
  }

$(document).on('click', '.text_content img', function () {
  showBig(this.src);
});






  function fetchFollowings(page, limit, user_id,guild_id){

      flow.load({
        elem: '#ID-flow-followings',
        scrollElem: '#ID-flow-followings',
        done: function(page, next){
          if (guild_id<0) {
            let  guild_id = BigInt("{{gid}}");
          }else{
             guild_id = localStorage.getItem('message_guild');
          }

          console.log('guild_id+----'+ guild_id);
          $.ajax({
            url: '{{ url_for('twitter.page_followings') }}',
            type: 'GET',
            data: { page: page, user_id: user_id,  limit: 10 },
            dataType: 'json',
            headers: {
            'Authorization': 'Bearer ' + token,
            },
            success: function(res){
              var lis = [];
              // å‡è®¾åç«¯è¿”å› res.data æ˜¯æ•°ç»„ï¼Œres.total_pages æ˜¯æ€»é¡µæ•°
              $.each(res.data, function(index, item){
                  const contentEn = item.t2_description || '';
                  const contentHtml = formatContent(item.t2_description || '');
                  const contentId = `twitter-content-cn-${item.id || Math.random().toString(36).substr(2, 8)}`;
                   // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€è¿‘ä¸€å¤©çš„æ¶ˆæ¯
                  const now = Date.now();
                  const msgTime = new Date(item.timestamp).getTime();  // æ³¨æ„è¿™é‡Œæ—¶é—´æ ¼å¼è¦èƒ½è¢«è§£æ
                  const isRecent = (now - msgTime) <= 48 * 60 * 60 * 1000; // 24å°æ—¶å†…

                lis.push(`

                 <div class="tweet-card">
                      <!-- ä¸Šå±‚è´¦æˆ·ä¿¡æ¯ -->
                       <div class="sub-account">
                        <a class="view-link" href="https://x.com/${item.t1_username}" target="_blank" >
                        <img class="avatar" src="${item.t1_avatar}" alt="Avatar">
                        </a>
                        <div class="sub-info">

                          <span class="sub-name"><a href="https://x.com/${item.t1_username}" target="_blank" >${item.t1_show_name}</a></span>
                          <span class="sub-handle"><a  href="https://x.com/${item.t1_username}" target="_blank" class="handle" >@${item.t1_username}</a></span>

                        </div>

                        <span class="follow-btn">å…³æ³¨äº†</span>
                      </div>

                      <hr class="divider">

                      <!-- ä¸»è´¦æˆ·ä¿¡æ¯ -->
                      <div class="main-account">
                      <a class="view-link" href="https://x.com/${item.t2_username}" target="_blank" >
                        <img class="sub_avatar" src="${item.t2_avatar}" alt="Avatar">
                        <div class="main-info">
                          <div class="main-header">
                          <span class="name">${item.t2_show_name}</span>
                          <span class="timestamp"> &nbsp;</span>
                        </div>
                        </a>
                        <span class="handle">@${item.t2_username}</span>

                          <div class="description">
                            ${item.t2_description}
                             ${contentEn  ? `
                            <p class="message-zh" id="${contentId}">
                            <img src="{{ url_for('static', filename='dist/img/laoding_2.gif') }}" alt="loading" class="opacity-75 shadow">
                            </p>
                            ` : ''}
                          </div>

                        </div>
                      </div>
                </div>

                `);

                  // å¼‚æ­¥ç¿»è¯‘å¹¶å¡«å…¥å¯¹åº”ä½ç½®
                  translateToZh(contentEn).then(result => {
                    document.getElementById(contentId).innerText = result;
                  }).catch(() => {
                    //document.getElementById(contentId).innerText = 'ç¿»è¯‘å¤±è´¥';
                  });
              });
              // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
              next(lis.join(''), page < res.count);
            },
            error: function(){
              // è¯·æ±‚å¤±è´¥æ—¶æç¤ºå¹¶ç»“æŸåŠ è½½
              next('', false);
            }
          });
        }
      });
  }


  function fetchMessage(page, limit, user_id,guild_id){

      flow.load({
        elem: '#ID-flow-demo',
        scrollElem: '#ID-flow-demo',
        done: function(page, next){
          if (guild_id<0) {
            let  guild_id = BigInt("{{gid}}");
          }else{
             guild_id = localStorage.getItem('message_guild');
          }

          console.log('guild_id+----'+ guild_id);
          $.ajax({
            url: '{{ url_for('twitter.page_messages') }}',
            type: 'GET',
            data: { page: page, user_id: user_id,  limit: 10 },
            dataType: 'json',
            headers: {
            'Authorization': 'Bearer ' + token,
            },
            success: function(res){
              var lis = [];
              // å‡è®¾åç«¯è¿”å› res.data æ˜¯æ•°ç»„ï¼Œres.total_pages æ˜¯æ€»é¡µæ•°
              $.each(res.data, function(index, item){
                  const contentEn = item.content || '';
                  const contentHtml = formatContent(item.content || '');
                  const contentId = `content-cn-${item.id || Math.random().toString(36).substr(2, 8)}`;
                  let contentSonId = '';  // é»˜è®¤è®¾ä¸ºç©º
                  if (item.original_tweet_user_id) {
                        const contentSonEn = item.data_original_tweets.content || '';
                        contentSonId = `son-content-cn-${item.id || Math.random().toString(36).substr(2, 8)}`;
                         // å¼‚æ­¥ç¿»è¯‘å¹¶å¡«å…¥å¯¹åº”ä½ç½®
                         setTimeout(() => {
                          if (contentSonEn && contentSonId && document.getElementById(contentSonId)) {
                            console.log('contentSonEn:'+ contentSonEn);
                            console.log('contentSonId:'+ contentSonId);
                            translateToZh(contentSonEn).then(result => {

                                console.log('result ----'+ result);
                                document.getElementById(contentSonId).innerText = result;
                            }).catch(() => {
                              console.warn('ç¿»è¯‘å¤±è´¥:', contentSonEn);
                            });
                          } else {
                            console.warn('contentSonId æœªå®šä¹‰æˆ– DOM ä¸å­˜åœ¨ï¼š', contentSonId);
                          }
                        },2000);

                  }
                   // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€è¿‘ä¸€å¤©çš„æ¶ˆæ¯
                  const now = Date.now();
                  const msgTime = new Date(item.timestamp).getTime();  // æ³¨æ„è¿™é‡Œæ—¶é—´æ ¼å¼è¦èƒ½è¢«è§£æ
                  const isRecent = (now - msgTime) <= 48 * 60 * 60 * 1000; // 24å°æ—¶å†…

                lis.push(`

                  <div class="tweet-container">

                    <!-- ä¸»æ¨æ–‡ -->
                    <section class="tweet">
                      <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
                      <a class="view-link" href="https://x.com/${item.username}" target="_blank" >
                      <img class="avatar" src="${item.avatar}" alt="${item.username} Avatar">
                      </a>
                      <div class="content">
                        <div class="header">
                          <div class="user-info">
                            <a class="view-link" href="https://x.com/${item.username}" target="_blank" >
                            <span class="name">${item.show_name}</span>
                            <span class="handle">@${item.username}</span>
                            </a>
                            <span class="timestamp">Â· ${item.created_at}</span>
                          </div>
                          <a class="view-link" href="https://x.com/${item.username}/status/${item.tweet_id}" target="_blank" >
                          <button type="button" class="layui-btn layui-btn-normal layui-btn-sm layui-btn-radius layui-btn-touyan">æŸ¥çœ‹åŸæ–‡</button></a>
                        </div>

                        <!-- æ­£æ–‡ -->
                        <p class="text_content">${linkifyShortUrls(item.content)}</p>
                        <p class="message-zh" id="${contentId}">
                        <img src="{{ url_for('static', filename='dist/img/laoding_2.gif') }}" alt="loading" class="opacity-75 shadow">
                        </p>

                       <!-- åˆ¤æ–­ original_tweet_id æ˜¯å¦æœ‰å€¼å†æ¸²æŸ“å¼•ç”¨æ¨æ–‡å¡ç‰‡ -->
                       ${item.original_tweet_user_id  ? `
                        <!-- å¼•ç”¨æ¨æ–‡å¡ç‰‡ -->
                        <div class="quoted-tweet">
                          <div class="quoted-header">
                            <img class="avatar" src="${item.data_original_user.avatar}" alt="Avatar">
                            <div>
                              <span class="name">${item.data_original_user.show_name}</span>
                              <span class="handle">@${item.data_original_user.username}</span>
                              <span class="timestamp">Â· ${formatTimestamp(item.data_original_tweets.created_at)}</span>
                            </div>
                            <a class="view-link" href="https://x.com/${item.data_original_user.username}/status/${item.data_original_tweets.tweet_id}" target="_blank">
                            <button type="button" class="layui-btn layui-btn-normal layui-btn-sm layui-btn-radius layui-btn-touyan">æŸ¥çœ‹åŸæ–‡</button>
                            </a>
                          </div>
                          <p class="text_content">
                           ${linkifyShortUrls(item.data_original_tweets.content)}
                          </p>
                          <p class="message-zh" id="${contentSonId}">
                          <img src="{{ url_for('static', filename='dist/img/laoding_2.gif') }}" alt="loading" class="opacity-75 shadow">
                          </p>
                        </div>
                        ` : ''}

                        <!-- äº¤äº’æ  -->
                        <!--
                        <div class="tweet-actions">
                          <span>ğŸ’¬ ${item.replies}</span>
                          <span>ğŸ” ${item.retweets}</span>
                          <span>â¤ï¸ ${item.likes}</span>
                        </div>
                        -->
                      </div>
                    </section>

                  </div>


                `);


                  setTimeout(() => {
                      // å¼‚æ­¥ç¿»è¯‘å¹¶å¡«å…¥å¯¹åº”ä½ç½®
                      translateToZh(contentEn).then(result => {
                        document.getElementById(contentId).innerText = result;
                      }).catch(() => {
                        //document.getElementById(contentId).innerText = 'ç¿»è¯‘å¤±è´¥';
                      });
                  }, 500);

              });
              // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
              next(lis.join(''), page < res.count);
            },
            error: function(){
              // è¯·æ±‚å¤±è´¥æ—¶æç¤ºå¹¶ç»“æŸåŠ è½½
              next('', false);
            }
          });
        }
      });
  }


  // ç›‘å¬åˆ†ç±»æŒ‰é’®ç‚¹å‡»
  $('#category_html').on('click', '.layui-btn', function() {
        user_id = $(this).data('id');
        // æ ·å¼åˆ‡æ¢ï¼šç§»é™¤å…¶ä»–æŒ‰é’®çš„ curï¼Œæ·»åŠ å½“å‰æŒ‰é’®çš„ cur
        $('#category_html .layui-btn').removeClass('layui-btn-touyan');
        $('#category_html .layui-btn').addClass('layui-btn-primary');
        $(this).addClass('layui-btn-touyan');
        $('#ID-flow-demo').html('');  // æ¸…ç©ºå½“å‰å†…å®¹
        const message_guild = localStorage.getItem('message_guild');
        localStorage.setItem('message_did', user_id);
        //åŠ è½½æ•°æ®
        fetchMessage(1,10,user_id,message_guild)// ç‚¹å‡»åˆ†ç±»æ—¶é‡ç½®ä¸ºç¬¬ä¸€é¡µ
         $('#ID-flow-followings').html('');  // æ¸…ç©ºå½“å‰å†…å®¹
        //åŠ è½½æœ€æ–°å…³æ³¨æ•°æ®
        setTimeout(() => {
             fetchFollowings(1,10,user_id,0)
        }, 400);

  });


  // âœ… å–åˆ°åˆ†ç±»åˆ—è¡¨
  function getUser(){
       const  user_id = 0;
       const token = localStorage.getItem('token');
       $.ajax({
        url:'{{ url_for('twitter.listuser') }}',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        type: 'GET',
        data: { is_type: 2 },
        success: function(res) {
          if (res.status === 1 && Array.isArray(res.data)) {
            const select = $('#category_html');
            select.empty();  // æ¸…ç©ºæ—§å†…å®¹
            if (user_id>0) {
                select.append('<button type="button" data-id="0"  class="layui-btn layui-btn-primary layui-btn-sm " >å…¨éƒ¨æ¨ç‰¹è´¦å·</button>');
            }else{
                select.append('<button type="button" data-id="0"  class="layui-btn  layui-btn-sm layui-btn-touyan"  >å…¨éƒ¨æ¨ç‰¹è´¦å·</button>');
            }


            res.data.forEach(item => {
                const selected = (parseInt(item.tid) === parseInt(user_id)) ? '' : 'layui-btn-primary';
                console.log(item.tid+'----'+ user_id);
                select.append(`<button type="button" data-id="${item.tid}" class="layui-btn  layui-btn-sm  ${selected}"  > ${item.show_name}</button>`);
            });

          } else {
            layer.msg('ä¸‹æ‹‰æ•°æ®åŠ è½½å¤±è´¥');
          }
        },
        error: function() {
          //layer.msg('è¯·æ±‚å‡ºé”™');
        }
      });
  }

  function updateMessage() {
        const did = 0;
        const token = localStorage.getItem('token');

        // è·å–ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        const lastUpdateTime = localStorage.getItem('updatetime');
        const now = Date.now();

        // å¦‚æœåœ¨1å°æ—¶å†…ï¼Œè·³è¿‡è¯·æ±‚
        if (lastUpdateTime && (now - parseInt(lastUpdateTime) < 60 * 60 * 1000)) {
            console.log('ğŸ” è·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´æœªè¶…è¿‡2å°æ—¶ï¼Œè·³è¿‡è¯·æ±‚');
            return;
        }

        // å‘èµ·è¯·æ±‚
        $.ajax({
            url: '/api/auth/update_message',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            type: 'GET',
            data: {},
            success: function (res) {
                if (res.status === 1) {
                    // æˆåŠŸåæ›´æ–° updatetime
                    localStorage.setItem('updatetime', Date.now().toString());
                    console.log('ğŸ” æ›´æ–°æ—¶é—´'+Date.now().toString());
                }
            },
            error: function () {
                console.log('è¯·æ±‚å‡ºé”™');
            }
        });
    }


  //åŠ è½½æ•°æ®
  fetchMessage(1,10,0,0)
  //åŠ è½½æœ€æ–°å…³æ³¨æ•°æ®
  setTimeout(() => {
     fetchFollowings(1,10,0,0)
  }, 250);
  //ä¸»åŠ¨æ›´æ–°ä¿¡æ¯
  setTimeout(updateMessage, 800);

   //å–åˆ°åˆ†ç±»æ›´æ–°ä¿¡æ¯
  setTimeout(getUser, 300);



});
</script>
{% endblock %}