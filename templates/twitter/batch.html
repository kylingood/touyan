{% extends "base.html" %}

{% block content %}


 <!--begin::App Content Header-->
        <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6"><h4 class="mb-0">æ‰¹é‡å¢åŠ æ¨ç‰¹</h4></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"> <button type="button" class="layui-btn btn-success layui-btn-touyan" lay-on="add-category-page-custom" ><b>ï¼‹ æ‰¹é‡å¢åŠ </b></button></li>
                </ol>
              </div>
            </div>
            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">
                 <!--begin::Row-->
                    <div  style="text-align:center;">

                    <div class="layui-form-item">
                    <div class="layui-inline">
                      <label class="layui-form-label">æœç´¢ï¼š</label>
                      <div class="layui-input-inline layui-input-wrap" style="width:500px;">
                        <input type="input" name="keyword" id="search_keyword" lay-verify="required|phone" autocomplete="off" lay-reqtext="è¯·å¡«å†™æ‰‹æœºå·" lay-affix="clear" class="layui-input demo-phone">
                      </div>
                      <div class="layui-form-mid" style="padding: 0!important;">
                        <button type="button" class="layui-btn layui-btn-primary" id="search_keyword_button" lay-on="get-vercode">å¼€å§‹æœç´¢</button>
                      </div>
                    </div>
                      </div>

                    </div>
                  <!--end::Row-->
               <div class="card mb-4">
                  <div class="card-header">
                    <h3 class="card-title">æ¨ç‰¹ç›‘æ§åˆ—è¡¨</h3>
                  </div>
                  <!-- /.card-header -->
                  <div class="card-body p-0">
                    <form class="layui-form" id="address-form">
                    <table class="table table-striped" style="text-align: center;">
                      <thead>
                        <tr>
                          <th style="width: 80px">åºå·</th>
                          <th style="text-align:left;" >æ¨ç‰¹è´¦å·</th>
                          <th>æ‰€å±åˆ†ç»„</th>
                          <th>å…³æ³¨äººæ•°</th>
                          <th>ç²‰ä¸é‡</th>
                          <th>å¤‡æ³¨</th>
                          <th >ç®€ä»‹</th>
                          <th style="width: 150px">æ“ä½œ</th>
                        </tr>
                      </thead>
                      <tbody id="address-body">


                      </tbody>
                    </table>

                        <div style="text-align: center;margin:20px" >
                           <div class="btn-container">
                              <button type="button" id="add-touyan-btn"  class="layui-btn btn-success" lay-on="add-category-page-custom" ><b>ï¼‹ æ‰¹é‡å¢åŠ </b></button>
                              &nbsp;&nbsp;&nbsp;&nbsp;<button type="submit" id="submit-touyan-btn" class="layui-btn layui-btn-touyan" ><b>ç¡®å®šæäº¤</b></button>
                            </div>

                    </div>
                   </form>

                  </div>
                  <!-- /.card-body -->
                </div>
                <!-- /.card -->



          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->

<script>

function filterValidRemarks(remarks) {
  // æ­£åˆ™ï¼šéªŒè¯åˆæ³•çš„ URL
  const validUrlRegex = /^(https:\/\/(x\.com|twitter\.com)\/[a-zA-Z0-9_]+)$/;

  // è¿‡æ»¤ remark ä¸­çš„æ¯ä¸€è¡Œ
  const validRemarks = remarks.split('\n').filter(line => {
    // å¦‚æœè¿™è¡ŒåŒ…å« URLï¼ŒéªŒè¯å…¶æ˜¯å¦åˆæ³•
    const urls = line.match(validUrlRegex);
    return urls && urls.length > 0;  // å¦‚æœåŒ¹é…åˆ°åˆæ³• URLï¼Œä¿ç•™è¯¥è¡Œ
  });

  return validRemarks;  // è¿”å›è¿‡æ»¤åçš„åˆæ³• remark æ•°ç»„
}

layui.use(['laypage', 'jquery','form'], function() {
  var laypage = layui.laypage;
  var $ = layui.jquery;
  const token = localStorage.getItem('token');
  const form = layui.form; // åˆå§‹åŒ–formæ¨¡å—

 // å¢åŠ æœç´¢å§”æ‰˜ç»™ body æˆ–æ›´åˆé€‚çš„çˆ¶å®¹å™¨
  $('body').on('click keydown', '#search_keyword_button, #search_keyword', function (e) {
      if (e.type === 'click' || (e.type === 'keydown' && e.key === 'Enter')) {
        const keyword = $("#search_keyword").val().trim();

        fetchData(1, 10,keyword);  // é»˜è®¤åŠ è½½ç¬¬1é¡µï¼Œ10æ¡æ•°æ®
      }
  });
  let currentKeyword = ''; // å…¨å±€å˜é‡ï¼Œè®°ä½ keyword
  function fetchData(page, limit, keyword) {
    currentKeyword = keyword || '';  // æ¯æ¬¡ fetch æ›´æ–°å½“å‰ keyword
    $.ajax({
      url: '{{ url_for('category.page') }}',  // æ›¿æ¢ä¸ºä½ çš„åç«¯æ¥å£
      type: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      data: { page: page, limit: limit,is_type: 1,keyword: currentKeyword  },
      success: function(res) {
        // å‡è®¾ res æ ¼å¼ï¼š{ code: 0, count: 100, data: [...] }
        if (res.code === 0) {
          renderTable(res.data);  // æ¸²æŸ“è¡¨æ ¼
          laypage.render({
            elem: 'demo-laypage-all',
            count: res.count,
            limit: limit,
            curr: page,
            layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'], // åŠŸèƒ½å¸ƒå±€
            jump: function(obj, first) {
              if (!first) {
                fetchData(obj.curr, obj.limit,currentKeyword);  // é‡æ–°è·å–æ•°æ®
              }
            }
          });
        }
      }
    });
  }


      function formatTimestamp(unixTime) {
          if (!unixTime || unixTime <= 0) {
            return '-';
          }
          const date = new Date(unixTime * 1000); // å¦‚æœæ˜¯æ¯«ç§’åˆ™ä¸ä¹˜
          const Y = date.getFullYear();
          const M = String(date.getMonth() + 1).padStart(2, '0');
          const D = String(date.getDate()).padStart(2, '0');
          const h = String(date.getHours()).padStart(2, '0');
          const m = String(date.getMinutes()).padStart(2, '0');
          return `${Y}/${M}/${D} ${h}:${m}`;
     }

  function renderTable(data) {
    var html = '';
    const colorClasses = [
      'layui-bg-orange',
      'layui-bg-green',
      'layui-bg-blue',
      'layui-bg-black'
    ];

    data.forEach(function(item) {
      // éšæœºé€‰æ‹©ä¸€ä¸ª class
      const randomClass = colorClasses[Math.floor(Math.random() * colorClasses.length)];
      html += `<tr class="align-middle" id="del_twitter_${item.id}">
                          <td>${item.num}.</td>
                          <td><span class="layui-badge ${randomClass} ">${item.title}</span></td>
                          <td>${item.total}</td>
                          <td>${item.remark}</td>
                          <td>${formatTimestamp(item.created)}</td>
                          <td>
                          <div class="layui-btn-container">
                          <span   lay-on="edit-confirm"  data-id="${item.id}" data-title="${item.title}" data-remark="${item.remark}" ><button type="button" class="layui-btn layui-bg-blue  layui-btn-sm">ä¿®æ”¹</button></span>
                          <span   lay-on="del-confirm"  data-id="${item.id}" ><button type="button" class="layui-btn layui-bg-red  layui-btn-sm">åˆ é™¤</button></span>
                          </div>
                          </td>
                        </tr>`;
    });
    $('#data-table').html(html);
  }

  fetchData(1, 10);  // é»˜è®¤åŠ è½½ç¬¬1é¡µï¼Œ10æ¡æ•°æ®
});

layui.use(function(){
  var $ = layui.$;
  var layer = layui.layer;
  var util = layui.util;
  var form = layui.form;

  const token = localStorage.getItem('token');


    let maxRows = 20; // æœ€å¤§è¡Œæ•°
    let rowCount = 0;


    function addRow(data = {}) {

      if (rowCount < maxRows) {
        const index = rowCount;
        const {
          url = '',
          tid = '',
          cid = '',
          avatar = '',
          username = '',
          show_name = '',
          coin = '',
          followers = '',
          fans = '',
          remark = '',
          description = ''
        } = data;

        const row = `
         <tr data-index="${index}">
            <td class="index">${index + 1}</td>
            <td>
             <a href="${url}" class="alert-link" target="_blank">
               <div style="display: flex; align-items: center; gap: 10px;text-align:left;">
                  <img src="${avatar  || '/static/dist/assets/img/logo.png' }" class="user-image rounded-circle shadow" style="width:40px; height:40px;" alt="User Image">
                  <div style="display: flex; flex-direction: column;">
                    <div style="font-weight: bold;">${show_name  || ''}</div>
                    <div style="font-size: 0.9em; color: #666;">@${username || ''}</div>
                  </div>
                </div>
             </a>
             <input type="hidden" name="addresses[${index}][url]" value="${url}">
             <input type="hidden" name="addresses[${index}][tid]" value="${tid}">
              <input type="hidden" name="addresses[${index}][username]" value="${username}">
             <input type="hidden" name="addresses[${index}][avatar]" value="${avatar}">
             <input type="hidden" name="addresses[${index}][show_name]" value="${show_name}">
            </td>
            <td>


               <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-list"></i>
                  </div>
                    <select  name="addresses[${index}][cid]"   id="category_select_${index}" lay-verify="required" lay-search>
                      <option value="">é€‰æ‹©æˆ–æœç´¢åˆ†ç»„</option>
                    </select>
                 </div>
              </div>

            </td>
            <td>

            <input type="text" name="addresses[${index}][followers]" class="layui-input" placeholder="å…³æ³¨äººæ•°" value="${followers}">

            </td>
            <td>
             <input type="text" name="addresses[${index}][fans]" class="layui-input" placeholder="ç²‰ä¸é‡" value="${fans}">

            </td>
            <td>
            <input type="text" name="addresses[${index}][remark]" class="layui-input" placeholder="æ¨ç‰¹å¤‡æ³¨" value="${remark}">
            </td>
            <td>
            <div class="layui-input-inline layui-input-wrap">
             <input type="text" name="addresses[${index}][description]" class="layui-input" placeholder="æ¨ç‰¹å¤‡æ³¨" value="${description}">
             </div>
            </td>
            <td>
              <button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-btn">åˆ é™¤</button>
            </td>
          </tr>
        `;

        $('#address-body').append(row);
        rowCount++;

          $.ajax({
            url: '{{ url_for("category.list") }}',
            headers: {
              'Authorization': 'Bearer ' + token,
            },
            type: 'GET',
            data: { is_type: 1 },
            success: function(res) {
              if (res.status === 1 && Array.isArray(res.data)) {
                const select = $('#category_select_' + index);
                select.empty();  // æ¸…ç©ºæ—§å†…å®¹
                select.append('<option value="">ç›´æ¥é€‰æ‹©æˆ–æœç´¢åˆ†ç»„</option>');

                res.data.forEach(item => {
                  // å¦‚æœæœ‰ cid å¹¶ä¸” item.id === cidï¼Œå°±æ·»åŠ  selected å±æ€§
                  const selected = cid && item.id == cid ? 'selected' : '';
                  select.append(`<option value="${item.id}" ${selected}>${item.title}</option>`);
                });

                form.render('select');  // â­ é‡è¦ï¼šé‡æ–°æ¸²æŸ“ layui select
              } else {
                layer.msg('ä¸‹æ‹‰æ•°æ®åŠ è½½å¤±è´¥');
              }
            },
            error: function() {
              layer.msg('è¯·æ±‚å‡ºé”™');
            }
          });

        form.render('select');
      }

      if (rowCount >= maxRows) {
        $('#add-btn').addClass('layui-btn-disabled').attr('disabled', true);
      }
    }

    // ç‚¹å‡»æ·»åŠ æŒ‰é’®
    $('#add-btn').click(function () {
      addRow();
    });

    // åˆ é™¤è¡Œ
    $('#address-body').on('click', '.delete-btn', function () {
      const _this = this; // ğŸ‘ˆ ä¿å­˜å½“å‰ç‚¹å‡»æŒ‰é’®çš„ this

      layer.confirm('ä½ ç¡®å®šåˆ é™¤æ­¤ä¿¡æ¯ï¼Ÿ', {
            btn: ['ç¡®å®š', 'å–æ¶ˆ']
      }, function () {
            $(_this).closest('tr').remove();  // ğŸ‘ˆ ç”¨ä¿å­˜çš„ _this åˆ é™¤å¯¹åº”è¡Œ
            rowCount--;
            form.render('select'); // é‡æ–°æ¸²æŸ“
            updateIndexes();
            $('#add-btn').removeClass('layui-btn-disabled').attr('disabled', false);
           layer.closeAll();       // å…³é—­æ‰€æœ‰ç±»å‹å¼¹çª—
           return true
      });
    });

    // æ›´æ–°ç¼–å·
    function updateIndexes() {
      $('#address-body tr').each(function (i) {
        $(this).find('.index').text(i + 1);
        $(this).attr('data-index', i);
        $(this).find('select, input').each(function () {
          const name = $(this).attr('name');
          if (name) {  // ç¡®ä¿ name å±æ€§å­˜åœ¨
            const key = name.split('[')[2].replace(']', '');
            $(this).attr('name', `addresses[${i}][${key}]`);
          }
        });
      });
    }


    // æäº¤è¡¨å•
    $('#address-form').on('submit', function (e) {



        e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º

        const rawData = $(this).serializeArray();
        const grouped = {};

        rawData.forEach(({ name, value }) => {
          const match = name.match(/^addresses\[(\d+)]\[(\w+)]$/);
          if (match) {
            const [_, index, key] = match;
            grouped[index] = grouped[index] || {};
            grouped[index][key] = value;
          }
        });

        const alldata = Object.values(grouped); // è½¬æˆæ•°ç»„ç»“æ„
        console.log("æäº¤æ•°æ®ï¼š", alldata);
        // åˆ¤æ–­æ˜¯å¦ä¸ºç©º
        if (!alldata || alldata.length === 0) {
          layer.msg("æäº¤çš„æ¨ç‰¹æ•°æ®åˆ—è¡¨ä¸èƒ½ä¸ºç©º"); // ä½¿ç”¨ layui å¼¹å‡ºæç¤º
          return; // é˜»æ­¢åç»­æ‰§è¡Œ
        }
        $("#submit-touyan-btn").html("è¯·ç¨ç­‰ï¼Œæ­£åœ¨æäº¤æ•°æ®...").attr("disabled","disabled");
        $.ajax({
            url: '{{ url_for('twitter.addbatch') }}',  // â¬…ï¸ æ”¹æˆä½ çš„åç«¯åœ°å€
            headers: {
                  'Authorization': 'Bearer ' + token,
            },
            dataType:"json",
            type:"post",
            async:false,
            contentType: 'application/json',
            data: JSON.stringify({ alldata }), // ğŸ‘ˆ æäº¤ JSON æ•°æ®
            success: function (result) {
              if (result.status === 1) {
                 layer.confirm(result.message, {
                      btn: ['ç¡®å®š', 'å…³é—­'] //æŒ‰é’®
                    }, function(){
                      window.location.href='{{ url_for('twitter.index') }}';
                    }, function(){
                      window.location.href='{{ url_for('twitter.index') }}';
                    });
                    return true
              } else {
                $("#submit-touyan-btn").html("<b>ç¡®å®šæäº¤</b>").removeAttr("disabled");

                return layer.msg(result.message);
              }
            },
            error: function () {
                $("#submit-touyan-btn").html("<b>ç¡®å®šæäº¤</b>").removeAttr("disabled");
                return layer.msg(result.message);

            }
      });
    });


  // äº‹ä»¶
  util.on('lay-on', {
    'del-confirm': function(){
      const id = $(this).data('id');       // è·å– data-id çš„å€¼

        layer.confirm('ä½ ç¡®å®šåˆ é™¤æ­¤ä¿¡æ¯ï¼Ÿ', {
        btn: ['ç¡®å®š', 'å–æ¶ˆ'] //æŒ‰é’®
      }, function(){
        // æ­¤å¤„å¯æ‰§è¡Œ Ajax ç­‰æ“ä½œ
        $.ajax({
                url:'{{ url_for('category.del_cate') }}',
                data:{
                    "id":id,
                },
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){
                        $('#del_twitter_'+id).remove();
                        layer.msg(result.message);
                        return true
                    }else{
                    	layer.msg(result.message);
                    	return false
                    }
                }
        })


      }, function(){
            return true

      });
    },

    'edit-confirm': function(){

      const id = $(this).data('id');       // è·å– data-id çš„å€¼
      const title = $(this).data('title');       // è·å– data-title çš„å€¼
      const remark = $(this).data('remark');       // è·å– data-remark çš„å€¼

      layer.open({
        type: 1,
        area: '350px',
        resize: false,
        shadeClose: true,
        title: 'ä¿®æ”¹åˆ†ç»„',
        content: `
          <div class="layui-form" lay-filter="filter-test-layer" style="margin: 16px;">
            <div class="demo-login-container">
              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-username"></i>
                  </div>

                  <input type="text" name="username" value="${title}" lay-verify="required" placeholder="åˆ†ç»„åç§°" lay-reqtext="è¯·å¡«å†™åˆ†ç»„" autocomplete="off" class="layui-input" lay-affix="clear">
                </div>
              </div>

              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-password"></i>
                  </div>
                    <textarea placeholder="è¯·è¾“å…¥æ­¤åˆ†ç»„å¤‡æ³¨" name="remark" class="layui-textarea" lay-verify="required"  lay-reqtext="è¯·å¡«å†™åˆ†ç»„å¤‡æ³¨"  >${remark}</textarea>
                     <input type="hidden" name="id" value="${id}" lay-verify="required" placeholder="åˆ†ç»„id"  autocomplete="off" >
                 </div>
              </div>

              <div class="layui-form-item">
                <button class="layui-btn layui-btn-fluid" id="add-button" lay-submit lay-filter="demo-login">ç¡®å®šä¿®æ”¹</button>
              </div>

            </div>
          </div>
        `,
        success: function(){
          // å¯¹å¼¹å±‚ä¸­çš„è¡¨å•è¿›è¡Œåˆå§‹åŒ–æ¸²æŸ“
          form.render();

          // è¡¨å•æäº¤äº‹ä»¶
          form.on('submit(demo-login)', function(data){

            $("#add-button").html("è¯·ç¨ç­‰ï¼Œæ­£åœ¨æäº¤æ•°æ®...").attr("disabled","disabled");
            // æ­¤å¤„å¯æ‰§è¡Œ Ajax ç­‰æ“ä½œ
            $.ajax({
                url:'{{ url_for('category.edit') }}',
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                data:{
                    "username":data.field.username,
                    "id":data.field.id,
                    "remark":data.field.remark
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){

                        layer.confirm(result.message, {
                          btn: ['ç¡®å®š', 'å…³é—­'] //æŒ‰é’®
                        }, function(){
                          window.location.href='{{ url_for('category.twitter') }}';
                        }, function(){
                          window.location.href='{{ url_for('category.twitter') }}';
                        });

                        return true

                    }else{
                    	$("#add-button").html("ç¡®å®šæäº¤").removeAttr("disabled");
                    	return layer.msg(result.message);
                    }
                }
            })
            return false; // é˜»æ­¢é»˜è®¤ form è·³è½¬
          });
        }
      });
    },
    'add-category-page-custom': function(){

      layer.open({
        type: 1,
        area: ['450px','450px'],
        resize: false,
        shadeClose: true,
        title: 'æ‰¹é‡å¢åŠ æ¨ç‰¹ç›‘æ§',
        content: `
          <div class="layui-form" lay-filter="filter-test-layer" style="margin: 16px;">

           <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-list"></i>
                  </div>
                    <select name="category_id" id="category_select" lay-verify="required" lay-search>
                      <option value="">é€‰æ‹©æˆ–æœç´¢åˆ†ç»„</option>
                    </select>
                 </div>
              </div>

            <div class="demo-login-container">
              <div class="layui-form-item">
                <div class="layui-input-wrap">
                  <div class="layui-input-prefix">
                    <i class="layui-icon layui-icon-password"></i>
                  </div>
                    <textarea placeholder="æ³¨æ„ï¼šè¯·å¡«ä¸»é¡µé“¾æ¥ï¼Œä¸€è¡Œä¸€ä¸ªè´¦å·ï¼Œä¸€æ¬¡æœ€å¤š20ä¸ªå·" name="remark" class="layui-textarea" style="height:260px" lay-reqtext="è¯·å¡«å†™æ¨ç‰¹åˆ—è¡¨" ></textarea>
                 </div>
              </div>

              <div class="layui-form-item">
                <button class="layui-btn layui-btn-fluid layui-btn-touyan" id="add-button" lay-submit lay-filter="demo-login">ç¡®å®šå¢åŠ </button>
              </div>

            </div>
          </div>
        `,
        success: function(){
          // å¯¹å¼¹å±‚ä¸­çš„è¡¨å•è¿›è¡Œåˆå§‹åŒ–æ¸²æŸ“
          form.render();
           // Step 2: å¼‚æ­¥åŠ è½½ä¸‹æ‹‰æ•°æ®
          $.ajax({
            url:'{{ url_for('category.list') }}',// âœ… ä½ åç«¯æ¥å£åœ°å€
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            type: 'GET',
            data: { is_type: 1 },
            success: function(res) {
              if (res.status === 1 && Array.isArray(res.data)) {
                const select = $('#category_select');
                select.empty();  // æ¸…ç©ºæ—§å†…å®¹
                select.append('<option value="">é€‰æ‹©æˆ–æœç´¢é»˜è®¤åˆ†ç»„</option>');
                res.data.forEach(item => {
                  select.append(`<option value="${item.id}">${item.title}</option>`);
                });
                form.render('select');  // â­ é‡è¦ï¼šé‡æ–°æ¸²æŸ“ layui select
              } else {
                layer.msg('ä¸‹æ‹‰æ•°æ®åŠ è½½å¤±è´¥');
              }
            },
            error: function() {
              //layer.msg('è¯·æ±‚å‡ºé”™');
            }
          });
          // è¡¨å•æäº¤äº‹ä»¶
          form.on('submit(demo-login)', function(data){
             const remark = data.field.remark;

              // æ£€æŸ¥ remark æ˜¯å¦ä¸ºç©º
              if (!remark || remark.trim() === '') {
                layer.msg('å¤‡æ³¨å­—æ®µä¸èƒ½ä¸ºç©º');
                return false;  // é˜»æ­¢è¡¨å•æäº¤
              }

            const remarks = filterValidRemarks(remark);
            console.log(remarks);  // è¿”å›çš„åº”ä¸ºä¸€ä¸ªæ•°ç»„
            // å¦‚æœ remarks æ˜¯æ•°ç»„ï¼Œè½¬æ¢æˆå­—ç¬¦ä¸²æ˜¾ç¤º
            if (remarks.length <= 0) {
                layer.msg('éƒ½ä¸æ˜¯åˆæ³•çš„æ¨ç‰¹ä¸»é¡µåœ°å€ï¼Œè¯·é‡æ–°å¡«å†™ï¼');
                return false;  // é˜»æ­¢è¡¨å•æäº¤
            }

            $("#add-button").html("è¯·ç¨ç­‰ï¼Œæ­£åœ¨æäº¤æ•°æ®...").attr("disabled","disabled");

            if (remarks.length >= 10) {
                const loadingIndex = layer.open({
                  type: 1,
                  title: false,
                  shadeClose: false,
                  shade: 0.3,
                  area: ['280px', '100px'],
                  content: `
                    <div style="text-align: center; padding: 20px;">
                      <img src="/static/dist/img/loading_3.gif" ><br>
                      <span style="display:block; margin-top:10px;">æ•°æ®é‡è¿‡å¤šï¼Œç³»ç»Ÿæ­£åœ¨æŠ“å–æ•°æ®ä¸­...</span>
                    </div>
                  `
                });
            }

            //return false;  // é˜»æ­¢è¡¨å•æäº¤
            // æ­¤å¤„å¯æ‰§è¡Œ Ajax ç­‰æ“ä½œ
            $.ajax({
                url:'{{ url_for('web3_auth.get_all_twitter') }}',
                headers: {
                    'Authorization': 'Bearer ' + token,
                },
                data:{
                    "remark":remark,
                    "cid":data.field.category_id,
                },
                dataType:"json",
                type:"post",
                async:false,
                success:function(result){
                    if(result.status == 1){
                        const serverData = result.data
                        // æ‰¹é‡æ·»åŠ æ•°æ®
                        serverData.forEach(item => {
                          addRow({
                            url: item.url,
                            avatar: item.avatar,
                            tid: item.rest_id,
                            cid: data.field.category_id,
                            username: item.username,
                            show_name: item.show_name,
                            followers: item.followers,
                            fans: item.fans,
                            remark: item.remark,
                            description: item.description
                          });
                        });
                        layer.closeAll();       // å…³é—­æ‰€æœ‰ç±»å‹å¼¹çª—
                        return true

                    }else{
                    	$("#add-button").html("ç¡®å®šæäº¤").removeAttr("disabled");
                    	return layer.msg(result.message);
                    }
                }
            })
            return false; // é˜»æ­¢é»˜è®¤ form è·³è½¬
          });
        }
      });
    }
  })
});
</script>

{% endblock %}