{% extends "base.html" %}

{% block content %}
<style>
.flow-demo {
  height: 70vh;
  overflow: auto;
  font-size: 0;
}

#ID-flow-demo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
  gap: 16px;
  padding: 16px;
}

.project-card {
  border: 1px solid #eee;
  border-radius: 10px;
  padding: 16px;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  max-width: 600px;
  margin: 16px auto;
  line-height: 1.6;

}

.header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}

.username {
  font-weight: bold;
  font-size: 16px;
}

.meta {
  font-size: 12px;

  margin-left: auto;
}

.intro {
  margin: 12px 0;
  font-size: 14px;

}

.evaluation-box {

  border-left: 4px solid #16b777;
  padding: 12px;
  border-radius: 6px;
  font-size: 14px;
  margin-bottom: 12px;
}

.score {
  font-weight: bold;
  color: #16b777;
  margin-bottom: 6px;
}

.section-title {
  font-weight: bold;
}

.section-title.teal {
  color: #16baaa;
}

.section-title.blue {
  color: #31bdec;
}

.footer {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: #666;
  border-top: 1px dashed #ddd;
  padding-top: 8px;
  margin-top: 10px;
}

.footer .links a {
  margin-left: 12px;
  color: #16b777;
  text-decoration: none;
}

.footer .links a:hover {
  text-decoration: underline;
}

</style>
 <!--begin::App Content Header-->
         <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6"><h4 class="mb-0">å…¨éƒ¨ç›‘æ§ä¿¡æ¯</h4></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item active" aria-current="page">
                      <a href="{{ url_for('discord.guild') }}" >
                        <button type="button" class="layui-btn">æŸ¥çœ‹å…¨éƒ¨ç›‘æ§é¢‘é“</button>
                      </a>
                  </li>
                </ol>
              </div>
            </div>

            <div class="layui-btn-container" id="category_html">

            </div>

            <div class="layui-btn-container" id="guild_html">

            </div>

            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">



            <div class="row">
              <div class="flow-demo" id="ID-flow-demo"></div>

            </div>


          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->

<script>

// ç¿»è¯‘å‡½æ•°ï¼ˆGoogle Translate éå®˜æ–¹æ¥å£ï¼‰
async function translateToZh(text) {
  const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`);
  const data = await res.json();
  return data[0].map(item => item[0]).join('');
}

function formatContent(content) {
  return content
    .replace(/<([^>\s]+)>/g, '$1') // å»æ‰å°–æ‹¬å·
    .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color: #16b777; text-decoration: underline;">$1</a>') // è®¾ç½®é¢œè‰²å’Œä¸‹åˆ’çº¿
    .replace(/\n/g, "<br>");
}

layui.use(['flow', 'jquery'], function(){
  var flow = layui.flow;
  var $ = layui.jquery;
  const token = localStorage.getItem('token');
  let  guild_id = BigInt("{{gid}}");
  let  did = 0;
  localStorage.setItem('message_did', did);
  localStorage.setItem('message_guild', guild_id);

  function fetchMessage(page, limit, did,guild_id){

      flow.load({
        elem: '#ID-flow-demo',
        scrollElem: '#ID-flow-demo',
        done: function(page, next){
          if (guild_id<0) {
            let  guild_id = BigInt("{{gid}}");
          }else{
             guild_id = localStorage.getItem('message_guild');
          }

          console.log('guild_id+----'+ guild_id);
          $.ajax({
            url: '{{ url_for('discord.page_messages') }}',
            type: 'GET',
            data: { page: page, did: did,guild_id: guild_id,  limit: 10 },
            dataType: 'json',
            headers: {
            'Authorization': 'Bearer ' + token,
            },
            success: function(res){
              var lis = [];
              // å‡è®¾åç«¯è¿”å› res.data æ˜¯æ•°ç»„ï¼Œres.total_pages æ˜¯æ€»é¡µæ•°
              $.each(res.data, function(index, item){
                  const contentEn = item.content || '';
                  const contentHtml = formatContent(item.content || '');
                  const contentId = `content-cn-${item.id || Math.random().toString(36).substr(2, 8)}`;
                   // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€è¿‘ä¸€å¤©çš„æ¶ˆæ¯
                  const now = Date.now();
                  const msgTime = new Date(item.timestamp).getTime();  // æ³¨æ„è¿™é‡Œæ—¶é—´æ ¼å¼è¦èƒ½è¢«è§£æ
                  const isRecent = (now - msgTime) <= 48 * 60 * 60 * 1000; // 24å°æ—¶å†…

                lis.push(`
                      <div class="project-card">
                          <section class="header">
                            <img src="https://pbs.twimg.com/profile_images/1871891133544251392/TnccZ1pt_normal.jpg" alt="avatar" class="avatar">
                            <span class="username">StarDoge <br/>(@StarDogeGold)</span>
                            <span class="meta">23 ç²‰ä¸ã€€<br/>æ³¨å†Œæ—¶é—´ï¼š2025/4/29 </span>
                          </section>

                          <p class="intro">
                            <strong>Gold Genesis:</strong> a Doge project like never before. Built for @Base.
                          </p>

                          <section class="evaluation-box">
                            <p class="score">è¯„åˆ†ï¼š45 ğŸ˜</p>
                            <p><strong class="section-title teal">AI æ€»ç»“ï¼š</strong> StarDogeæ˜¯ä¸€ä¸ªåŸºäºBaseé“¾çš„Dogeä¸»é¢˜åŠ å¯†è´§å¸é¡¹ç›®ï¼Œè‡ªç§°æ˜¯å‰æ‰€æœªæœ‰çš„Dogeé¡¹ç›®ï¼ˆGold Genesisï¼‰ã€‚é¡¹ç›®å®šä½å¯èƒ½ä¸memeå¸æˆ–ç¤¾åŒºé©±åŠ¨å‹ä»£å¸ç›¸å…³ï¼Œä½†ç›®å‰ä¿¡æ¯æœ‰é™ï¼Œç¼ºä¹è¯¦ç»†åŠŸèƒ½æˆ–è·¯çº¿å›¾è¯´æ˜ã€‚</p>
                            <p><strong class="section-title blue">è¯„åˆ†ç†ç”±ï¼š</strong> é¡¹ç›®åŸºæœ¬ä¿¡æ¯æ˜ç¡®ï¼ˆBaseé“¾ï¼ŒDogeä¸»é¢˜ï¼‰ï¼Œä½†ç¼ºä¹å…³é”®æ•°æ®æ”¯æŒï¼šæ— æ¨æ–‡å†…å®¹ã€äº’åŠ¨æ•°æ®æä½ï¼ˆä»…23ç²‰ä¸ï¼‰ã€æ— è·¯çº¿å›¾æˆ–ä»£å¸ä¿¡æ¯è¯´æ˜ï¼Œç–‘ä¼¼æ–°å¯åŠ¨é˜¶æ®µä¸”çƒ­åº¦ä¸è¶³ã€‚</p>
                          </section>

                          <footer class="footer">
                            <span class="time">æ¨é€æ—¶é—´ï¼š2025/5/3 13:20:33</span>
                            <span class="links">
                              <a href="#">æŸ¥çœ‹è¯¦æƒ…</a>
                              <a href="#">æ·»åŠ åˆ°è§‚å¯Ÿåˆ—è¡¨</a>
                            </span>
                          </footer>
                        </div>
                `);

                  // å¼‚æ­¥ç¿»è¯‘å¹¶å¡«å…¥å¯¹åº”ä½ç½®
                  translateToZh(contentEn).then(result => {
                    document.getElementById(contentId).innerText = result;
                  }).catch(() => {
                    //document.getElementById(contentId).innerText = 'ç¿»è¯‘å¤±è´¥';
                  });
              });
              // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
              next(lis.join(''), page < res.count);
            },
            error: function(){
              // è¯·æ±‚å¤±è´¥æ—¶æç¤ºå¹¶ç»“æŸåŠ è½½
              next('', false);
            }
          });
        }
      });
  }


  // ç›‘å¬åˆ†ç±»æŒ‰é’®ç‚¹å‡»
  $('#category_html').on('click', '.layui-btn', function() {
    did = $(this).data('id');
    // æ ·å¼åˆ‡æ¢ï¼šç§»é™¤å…¶ä»–æŒ‰é’®çš„ curï¼Œæ·»åŠ å½“å‰æŒ‰é’®çš„ cur
    $('#category_html .layui-btn').addClass('layui-btn-primary');
    $(this).removeClass('layui-btn-primary');
    $('#ID-flow-demo').html('');  // æ¸…ç©ºå½“å‰å†…å®¹
    const message_guild = localStorage.getItem('message_guild');
    localStorage.setItem('message_did', did);
    //åŠ è½½æ•°æ®
    fetchMessage(1,10,did,message_guild)// ç‚¹å‡»åˆ†ç±»æ—¶é‡ç½®ä¸ºç¬¬ä¸€é¡µ
  });

   // ç›‘å¬åˆ†ç±»æŒ‰é’®ç‚¹å‡»
  $('#guild_html').on('click', '.layui-btn', function() {
    guild_id = $(this).data('id');
     console.log('guild_id:@@@----'+ guild_id);
    // æ ·å¼åˆ‡æ¢ï¼šç§»é™¤å…¶ä»–æŒ‰é’®çš„ curï¼Œæ·»åŠ å½“å‰æŒ‰é’®çš„ cur
    $('#guild_html .layui-btn').addClass('layui-btn-primary');
    $(this).removeClass('layui-btn-primary');
    $('#ID-flow-demo').html('');  // æ¸…ç©ºå½“å‰å†…å®¹
    //åŠ è½½æ•°æ®
    const did = localStorage.getItem('message_did');
    localStorage.setItem('message_guild', guild_id);
     console.log('guild_id:###----'+ guild_id);
    fetchMessage(1,10,did,guild_id)// ç‚¹å‡»åˆ†ç±»æ—¶é‡ç½®ä¸ºç¬¬ä¸€é¡µ
  });


  // âœ… å–åˆ°é¢‘é“åˆ—è¡¨
  function getGuild(){
       let gid = BigInt("{{gid}}");
       const token = localStorage.getItem('token');
       $.ajax({
        url:'{{ url_for('discord.guild_data') }}',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        type: 'GET',
        success: function(res) {
          if (res.status === 1 && Array.isArray(res.data)) {
            const select = $('#guild_html');
            select.empty();  // æ¸…ç©ºæ—§å†…å®¹
            if (gid>0) {
                select.append('<button type="button" data-id="0"  class="layui-btn layui-btn-primary layui-btn-sm ">å…¨éƒ¨DiscordæœåŠ¡å™¨</button>');
            }else{
                select.append('<button type="button" data-id="0"  class="layui-btn  layui-btn-sm ">å…¨éƒ¨DiscordæœåŠ¡å™¨</button>');
            }


            res.data.forEach(item => {
                const selected = (BigInt(item.guild_id) === BigInt(gid)) ? '' : 'layui-btn-primary';
                console.log(item.guild_id+'----'+ gid);
                select.append(`<button type="button" data-id="${item.guild_id}" class="layui-btn  layui-btn-sm  ${selected}"> ${item.guild_name}</button>`);
            });

          } else {
            //layer.msg('ä¸‹æ‹‰æ•°æ®åŠ è½½å¤±è´¥');
          }
        },
        error: function() {
          layer.msg('è¯·æ±‚å‡ºé”™');
        }
      });
  }

    // âœ… å–åˆ°åˆ†ç±»åˆ—è¡¨
  function getCategory(){
       const  did = 0;
       const token = localStorage.getItem('token');
       $.ajax({
        url:'{{ url_for('discord.list') }}',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        type: 'GET',
        data: { is_type: 2 },
        success: function(res) {
          if (res.status === 1 && Array.isArray(res.data)) {
            const select = $('#category_html');
            select.empty();  // æ¸…ç©ºæ—§å†…å®¹
            if (did>0) {
                select.append('<button type="button" data-id="0"  class="layui-btn layui-btn-primary layui-btn-sm ">å…¨éƒ¨Discordè´¦å·</button>');
            }else{
                select.append('<button type="button" data-id="0"  class="layui-btn  layui-btn-sm ">å…¨éƒ¨Discordè´¦å·</button>');
            }


            res.data.forEach(item => {
                const selected = (parseInt(item.id) === parseInt(did)) ? '' : 'layui-btn-primary';
                console.log(item.id+'----'+ did);
                select.append(`<button type="button" data-id="${item.id}" class="layui-btn  layui-btn-sm  ${selected}"> ${item.global_name}</button>`);
            });

          } else {
            //layer.msg('ä¸‹æ‹‰æ•°æ®åŠ è½½å¤±è´¥');
          }
        },
        error: function() {
          layer.msg('è¯·æ±‚å‡ºé”™');
        }
      });
  }

  function updateMessage() {
        const did = 0;
        const token = localStorage.getItem('token');

        // è·å–ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        const lastUpdateTime = localStorage.getItem('updatetime');
        const now = Date.now();

        // å¦‚æœåœ¨1å°æ—¶å†…ï¼Œè·³è¿‡è¯·æ±‚
        if (lastUpdateTime && (now - parseInt(lastUpdateTime) < 60 * 60 * 1000)) {
            console.log('ğŸ” è·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´æœªè¶…è¿‡2å°æ—¶ï¼Œè·³è¿‡è¯·æ±‚');
            return;
        }

        // å‘èµ·è¯·æ±‚
        $.ajax({
            url: '/api/auth/update_message',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            type: 'GET',
            data: {},
            success: function (res) {
                if (res.status === 1) {
                    // æˆåŠŸåæ›´æ–° updatetime
                    localStorage.setItem('updatetime', Date.now().toString());
                    console.log('ğŸ” æ›´æ–°æ—¶é—´'+Date.now().toString());
                }
            },
            error: function () {
                console.log('è¯·æ±‚å‡ºé”™');
            }
        });
    }


   //åŠ è½½æ•°æ®
  fetchMessage(1,10,0,0)

   //ä¸»åŠ¨æ›´æ–°ä¿¡æ¯
  setTimeout(updateMessage, 800);

   //å–åˆ°åˆ†ç±»æ›´æ–°ä¿¡æ¯
  setTimeout(getCategory, 300);

   //å–åˆ°æœåŠ¡å™¨ä¿¡æ¯
  setTimeout(getGuild, 500);

});
</script>
{% endblock %}